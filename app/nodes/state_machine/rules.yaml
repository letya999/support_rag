# ============================================================
# State Machine Rules Engine Configuration
# ============================================================
# Declarative rules for state transitions based on dialog analysis signals.
# Priority: Lower number = higher priority (evaluated first)
#
# Available signals from dialog_analysis:
#   - is_gratitude: User expressed thanks
#   - escalation_requested: User explicitly asked for operator/human
#   - is_question: User is asking a question
#   - repeated_question: User is repeating a previous question
#   - frustration_detected: High negativity/frustration in user message
#   - sentiment: overall sentiment (positive, negative, neutral)
#   - topic_shift: User changed topic significantly
#
# Available states:
#   - INITIAL: Starting state for new conversations
#   - ANSWER_PROVIDED: Bot has provided an answer
#   - RESOLVED: User confirmed issue is resolved (gratitude)
#   - CLARIFY: Need more information from user
#   - EMPATHY_MODE: User frustrated, switch to empathetic tone
#   - ESCALATION_NEEDED: Should suggest handoff to operator
#   - ESCALATION_REQUESTED: User explicitly requested operator
#   - AWAITING_CLARIFICATION: Waiting for user to provide more details
# ============================================================

_meta:
  version: "1.0"
  description: "State transition rules for conversation management"

# Default settings
defaults:
  initial_state: INITIAL
  max_attempts_before_escalation: 3
  reset_on_gratitude: true
  escalate_on_extreme_frustration: true

# Transition rules - evaluated in priority order
# Each rule defines: when condition matches -> transition to target state
rules:
  # Priority 0: CRITICAL - Safety violation (highest priority)
  - name: safety_violation_detected
    priority: 0
    description: "Security threat detected by guardrails"
    condition:
      field: safety_violation
      operator: equals
      value: true
    target_state: SAFETY_VIOLATION
    actions:
      - type: log
        message: "Safety violation detected - immediate escalation"

  # Priority 1: Critical - User explicitly requests human
  - name: explicit_escalation_request
    priority: 1
    description: "User explicitly asked for operator/human support"
    condition:
      field: escalation_requested
      operator: equals
      value: true
    target_state: ESCALATION_REQUESTED
    actions:
      - type: log
        message: "User requested human support"

  # Priority 1.2: Stuck in loop - User going in circles (Move up from P7)
  - name: stuck_in_loop
    priority: 1.2
    description: "User is going in circles, same topic repeated multiple times"
    condition:
      field: topic_loop_detected
      operator: equals
      value: true
    target_state: STUCK_LOOP
    actions:
      - type: log
        message: "User stuck in loop, suggesting handoff"

  # Priority 1.3: Topic Shift - Break Clarification (Override P1.5)
  - name: topic_shift_break
    priority: 1.3
    description: "User changed topic during clarification - reset to INITIAL"
    condition:
      field: topic_shift
      operator: equals
      value: true
    target_state: INITIAL
    actions:
      - type: reset_attempt_count
      - type: log
        message: "Topic shift detected during clarification - resetting"

  # Priority 1.4: Refusal - Break Clarification (Override P1.5)
  - name: clarification_refusal
    priority: 1.4
    description: "User refused to answer clarification - escalate or answer partially"
    condition:
      field: refusal
      operator: equals
      value: true
    target_state: ESCALATION_NEEDED
    actions:
      - type: log
        message: "User refused to clarify - escalating"

  # Priority 1.5: Maintain Active Clarification (Overrides KB/Low Conf, but yields to Safety/Escalation/Shift)
  - name: maintain_clarification_mode
    priority: 1.5
    description: "Currently asking clarifying questions - continue unless safety/abuse issue/loop/shift"
    condition:
      field: current_state
      operator: equals
      value: NEEDS_CLARIFICATION
    target_state: NEEDS_CLARIFICATION
    actions: []

  # Priority 2: Knowledge Base requires handoff
  - name: kb_requires_handoff
    priority: 2
    description: "Retrieved document explicitly requires handoff"
    condition:
      field: requires_handoff
      operator: equals
      value: true
    target_state: ESCALATION_NEEDED
    actions:
      - type: log
        message: "Knowledge base document requires handoff"

  # Priority 3: Gratitude - Issue resolved
  - name: gratitude_resolution
    priority: 3
    description: "User expressed thanks, likely resolved"
    condition:
      field: is_gratitude
      operator: equals
      value: true
    target_state: RESOLVED
    actions:
      - type: reset_attempt_count
      - type: log
        message: "Issue resolved via gratitude signal"

  # Priority 4: High frustration - Switch to empathy mode
  - name: frustration_detected
    priority: 4
    description: "High frustration/negativity detected"
    condition:
      field: frustration_detected
      operator: equals
      value: true
    target_state: EMPATHY_MODE
    actions:
      - type: log
        message: "Frustration detected, switching to empathy mode"

  # Priority 5: Extreme negative sentiment - Suggest escalation
  - name: extreme_negative_sentiment
    priority: 5
    description: "Extreme negative sentiment over multiple messages"
    condition:
      field: sentiment
      operator: equals
      value: "extreme_negative"
    target_state: ESCALATION_NEEDED
    actions:
      - type: log
        message: "Extreme negativity, suggesting escalation"

  # Priority 6: Repeated question - Increment attempt counter
  - name: repeated_question
    priority: 6
    description: "User is repeating a question (possibly dissatisfied)"
    condition:
      field: repeated_question
      operator: equals
      value: true
    target_state: ANSWER_PROVIDED
    actions:
      - type: increment_attempts
      - type: log
        message: "Repeated question detected"
    post_condition:
      if_attempts_exceed: 3
      override_state: ESCALATION_NEEDED

  # Priority 7: Topic shift - Reset context
  - name: topic_shift
    priority: 7
    description: "User shifted to a new topic"
    condition:
      field: topic_shift
      operator: equals
      value: true
    target_state: INITIAL
    actions:
      - type: reset_attempt_count
      - type: log
        message: "Topic shift detected, resetting context"

  # Priority 8: Low confidence - First attempt, ask clarification
  - name: low_confidence_first_attempt
    priority: 8
    description: "Low confidence on first attempt - ask for clarification"
    condition:
      field: confidence_below_threshold
      operator: equals
      value: true
    target_state: LOW_CONFIDENCE
    requires_attempts_less_than: 2
    actions:
      - type: log
        message: "Low confidence - asking clarification"

  # Priority 9: Low confidence - Escalate after attempts
  - name: low_confidence_escalation
    priority: 9
    description: "Confidence below threshold after attempts - escalate"
    condition:
      field: confidence_below_threshold
      operator: equals
      value: true
    target_state: ESCALATION_NEEDED
    requires_attempts_gte: 2
    actions:
      - type: log
        message: "Low confidence after attempts - escalating to human"

  # Priority 10: Default question flow
  - name: standard_question
    priority: 10
    description: "Standard question flow"
    condition:
      field: is_question
      operator: equals
      value: true
    target_state: ANSWER_PROVIDED
    actions: []

# Dynamic rules - evaluated after static rules
dynamic_rules:
  # Max attempts exceeded -> Escalation
  - name: max_attempts_exceeded
    description: "Too many attempts, suggest handoff"
    condition:
      type: attempts_exceeded
      threshold_from_config: max_attempts_before_escalation
    target_state: ESCALATION_NEEDED
    requires_current_state: ANSWER_PROVIDED

# State-specific behaviors for prompt routing
state_behaviors:
  INITIAL:
    tone: professional
    action: auto_reply
    prompt_hint: "standard"

  ANSWER_PROVIDED:
    tone: helpful
    action: auto_reply
    prompt_hint: "follow_up"

  RESOLVED:
    tone: warm
    action: auto_reply
    prompt_hint: "closing"

  EMPATHY_MODE:
    tone: empathetic
    action: auto_reply
    prompt_hint: "empathy"

  CLARIFY:
    tone: curious
    action: auto_reply
    prompt_hint: "clarification"

  ESCALATION_NEEDED:
    tone: supportive
    action: handoff
    escalation_priority: 4
    escalation_reason: "low_confidence_or_repeated_failures"
    prompt_hint: "handoff_suggestion"

  ESCALATION_REQUESTED:
    tone: understanding
    action: handoff
    escalation_priority: 2
    escalation_reason: "user_requested"
    prompt_hint: "handoff_confirmation"

  SAFETY_VIOLATION:
    tone: professional
    action: handoff
    escalation_priority: 1
    escalation_reason: "safety_violation"
    prompt_hint: "safety_block"

  AWAITING_CLARIFICATION:
    tone: patient
    action: auto_reply
    prompt_hint: "waiting"

  LOW_CONFIDENCE:
    tone: curious
    action: auto_reply
    prompt_hint: "clarification"

  STUCK_LOOP:
    tone: supportive
    action: suggest_handoff
    escalation_priority: 3
    escalation_reason: "conversation_loop"
    prompt_hint: "handoff_suggestion"

