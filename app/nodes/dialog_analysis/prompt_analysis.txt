TASK: Classify user's latest support message into 4 categories.

=== CLASSIFICATION RULES ===

1. SIGNALS (boolean flags):
   - {SIGNAL_GRATITUDE}: Contains thanks or closing ("спасибо", "thank you", "благодарю", "хорошего дня", "goodbye")
   - {SIGNAL_ESCALATION_REQ}: Requests human ("оператор", "agent", "человек", "менеджер")
   - {SIGNAL_QUESTION}: Asks for help or information (ends with "?", seeks answer)
   - {SIGNAL_REPEATED}: Same issue mentioned in history
   - refusal: User explicitly refuses to answer or says "I don't know" / "Skip". IMPORTANT: If the previous system message was a Yes/No question, a simple "No" or "Yes" is NOT a refusal.
   - topic_shift: User changes subject completely (e.g. from "tech issue" to "pricing")

2. SENTIMENT (emotion):
   - positive: Happy, satisfied, grateful
   - neutral: Informational, calm
   - negative: Unhappy, disappointed
   - frustrated: Annoyed, impatient
   - angry: Very upset, aggressive
   - score: 0.0 (calm) to 1.0 (maximum intensity)

3. SAFETY (violations):
   Mark violation=true IF contains:
   - Hate speech, racism, discrimination
   - Insults toward staff/bot
   - Threats, blackmail
   - Off-topic: religion, philosophy, general knowledge

4. ESCALATION (routing):
   - "escalate" IF: explicit human request OR sentiment="angry" with score>0.7 OR safety violation
   - "auto_reply" OTHERWISE

=== EXAMPLES ===

Example 1:
User: "Спасибо за помощь!"
Output: {{"signals":{{{SIGNAL_GRATITUDE}:true,{SIGNAL_ESCALATION_REQ}:false,{SIGNAL_QUESTION}:false,{SIGNAL_REPEATED}:false}},"sentiment":{{"label":"positive","score":0.8}},"safety":{{"violation":false,"reason":null}},"escalation":{{"decision":"auto_reply","reason":null}}}}

Example 2:
User: "Соедините меня с оператором"
Output: {{"signals":{{{SIGNAL_GRATITUDE}:false,{SIGNAL_ESCALATION_REQ}:true,{SIGNAL_QUESTION}:false,{SIGNAL_REPEATED}:false}},"sentiment":{{"label":"neutral","score":0.3}},"safety":{{"violation":false,"reason":null}},"escalation":{{"decision":"escalate","reason":"explicit human request"}}}}

Example 3:
User: "Вы тупые, ничего не работает!!!"
Output: {{"signals":{{{SIGNAL_GRATITUDE}:false,{SIGNAL_ESCALATION_REQ}:false,{SIGNAL_QUESTION}:false,{SIGNAL_REPEATED}:false,"refusal":false,"topic_shift":false}},"sentiment":{{"label":"angry","score":0.9}},"safety":{{"violation":true,"reason":"insult to staff"}},"escalation":{{"decision":"escalate","reason":"safety violation + high anger"}}}}

Example 4:
AI: "What is your device?"
User: "I don't know, stop asking."
Output: {{"signals":{{{SIGNAL_GRATITUDE}:false,{SIGNAL_ESCALATION_REQ}:false,{SIGNAL_QUESTION}:false,{SIGNAL_REPEATED}:false,"refusal":true,"topic_shift":false}},"sentiment":{{"label":"frustrated","score":0.6}},"safety":{{"violation":false,"reason":null}},"escalation":{{"decision":"auto_reply","reason":null}}}}

Example 5:
AI: "Are you experiencing technical issues?"
User: "No"
Output: {{"signals":{{{SIGNAL_GRATITUDE}:false,{SIGNAL_ESCALATION_REQ}:false,{SIGNAL_QUESTION}:false,{SIGNAL_REPEATED}:false,"refusal":false,"topic_shift":false}},"sentiment":{{"label":"neutral","score":0.0}},"safety":{{"violation":false,"reason":null}},"escalation":{{"decision":"auto_reply","reason":null}}}}

=== INPUT DATA ===

Conversation history:
{history_text}

Latest user message:
{current_question}

=== OUTPUT FORMAT ===

Output ONLY valid JSON matching this EXACT structure:
{{"signals":{{{SIGNAL_GRATITUDE}:bool,{SIGNAL_ESCALATION_REQ}:bool,{SIGNAL_QUESTION}:bool,{SIGNAL_REPEATED}:bool,"refusal":bool,"topic_shift":bool}},"sentiment":{{"label":"positive|neutral|negative|frustrated|angry","score":0.0-1.0}},"safety":{{"violation":bool,"reason":"string or null"}},"escalation":{{"decision":"escalate|auto_reply","reason":"string or null"}}}}

CRITICAL: Output JSON only. No markdown. No explanation. No prefix text.
