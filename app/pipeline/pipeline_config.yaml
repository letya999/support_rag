# ============================================================
# Centralized Pipeline Configuration - AUTO-GENERATED
# ============================================================
# This file is automatically generated from:
# - app/nodes/*/config.yaml (node-specific configs)
# - app/nodes/_shared_config/*.yaml (shared configs)
# - app/pipeline/pipeline_order.yaml (pipeline sequence)
#
# Rules:
# 1. Node name is taken from node.name in local config.yaml (or folder name).
# 2. Numeric/Boolean params go to 'parameters', rest go to 'config'.
# 3. The 'pipeline' section order is defined in pipeline_order.yaml.
#
# To regenerate: python scripts/rebuild_pipeline_config.py
# ============================================================

pipeline:
- name: session_starter
  enabled: true
- name: check_cache
  enabled: true
- name: dialog_analysis
  enabled: true
- name: state_machine
  enabled: true
- name: aggregation
  enabled: true
- name: easy_classification
  enabled: true
- name: classify
  enabled: false
- name: metadata_filtering
  enabled: true
- name: expand_query
  enabled: false
- name: hybrid_search
  enabled: true
- name: retrieve
  enabled: false
- name: lexical_search
  enabled: false
- name: fusion
  enabled: false
- name: reranking
  enabled: true
- name: multihop
  enabled: true
- name: routing
  enabled: true
- name: prompt_routing
  enabled: true
- name: generation
  enabled: true
- name: archive_session
  enabled: true
- name: store_in_cache
  enabled: true
details:
  global:
    parameters:
      default_language: ru
      confidence_threshold: 0.3
      debug_mode: false
      persist_to_postgres: true
      session_ttl_hours: 24
      session_timeout_minutes: 30
      session_idle_threshold_minutes: 5
      timeout_ms: 5000
      retry_count: 3
  cache:
    parameters:
      backend: redis
      redis_url: ${REDIS_URL:-redis://redis:6379/0}
      ttl_seconds: 86400
      max_entries: 1000
  aggregation:
    parameters:
      history_messages_count: 3
      include_assistant_responses: true
      min_message_length: 2
      llm_temperature: 0
      llm_max_tokens: 200
      max_context_length: 200
    config:
      mode: lightweight
      llm_model: gpt-4o-mini
      lightweight:
        template: '[Контекст: {last_assistant_response}] Вопрос: {current_question}'
        fallback_template: '{current_question}'
  archive_session:
    parameters:
      save_to_postgres: true
      update_redis_session: true
      filter_system_messages: true
      generate_summary: true
      max_summary_length: 200
    config:
      summary_method: rule_based
  dialog_analysis:
    parameters:
      negative_sentiment_threshold: -0.3
      detect_repeated_questions: true
      inference_timeout_ms: 3000
    config:
      mode: rule_based
      keywords:
        escalation:
        - оператор
        - человек
        - менеджер
        - соедините
        - operator
        - human
        - agent
        - transfer
        gratitude:
        - спасибо
        - благодарю
        - thank
        - thanks
        frustration:
        - тупой
        - плохой
        - ужас
        - stupid
        - useless
        - bad
        - hate
  easy_classification:
    parameters:
      intent_confidence_threshold: 0.3
      category_confidence_threshold: 0.3
      skip_if_low_confidence: true
    config:
      fallback_intent: unknown
      fallback_category: General
      model:
        fasttext_model_path: models/intent_classifier.bin
        sentence_model: intfloat/multilingual-e5-small
  generation:
    parameters:
      temperature: 0.3
      max_tokens: 1000
      include_sources: true
      add_confidence_warning: true
      confidence_warning_threshold: 0.3
    config:
      model: gpt-4o-mini
  hybrid_search:
    parameters:
      vector_top_k: 10
      lexical_top_k: 10
      final_top_k: 10
      rrf_k: 60
      score_threshold: 0.0
      use_or_logic: true
      min_word_length: 2
    config:
      fusion_method: rrf
      collection_name: documents
  metadata_filtering:
    parameters:
      use_category_filter: true
      skip_on_unknown: true
    config:
      fallback_category: General
      filter_fields:
      - category
      - intent
      - language
  multihop:
    parameters:
      output_docs_count: 3
      max_hops: 2
      complexity_threshold: 1.5
      skip_if_high_confidence: true
      high_confidence_threshold: 0.8
      min_query_length: 10
    config:
      complexity_detection:
        complex_keywords:
        - как
        - почему
        - сравни
        - разница
        - how
        - why
        - compare
  prompt_routing:
    parameters:
      max_history_messages: 5
      max_message_length: 300
      include_user_profile: true
      include_entities: true
      filter_system_messages: true
      use_tone_modifiers: true
      use_session_summaries: true
    config:
      history_source: conversation_history
      history_formatting:
        message_template: '{role}: {content}'
        separator: '

          '
      fallback:
        summary_template: 'Предыдущий разговор: {summary}'
      tone_modifiers:
        professional: ''
        helpful: Будь дружелюбным и готовым помочь.
        warm: Отвечай тепло и с благодарностью.
        empathetic: Прояви эмпатию и понимание. Пользователь может быть расстроен.
        curious: Задавай уточняющие вопросы вежливо и конструктивно.
        supportive: Окажи поддержку и упомяни возможность связаться с оператором.
        understanding: Подтверди, что переключишь пользователя на живого оператора.
        patient: Терпеливо жди и предлагай дополнительную помощь.
  reranking:
    parameters:
      confidence_threshold: 0.3
      top_k: 5
      batch_size: 32
      use_gpu: true
      inference_timeout_ms: 5000
    config:
      model_name: BAAI/bge-reranker-v2-m3
  routing:
    parameters:
      min_confidence_auto_reply: 0.3
      respect_escalation_decision: true
      respect_requires_handoff: true
      clarification_enabled: true
    config:
      decision_priority:
        1: safety_violation
        2: escalation_requested
        3: requires_handoff
        4: low_confidence
        5: auto_reply
      clarification_confidence_range:
      - 0.3
      - 0.6
      always_escalate_categories:
      - billing_dispute
      - account_closure
      - complaint
      - refund_request
      always_escalate_intents:
      - urgent
      - vip
      - escalation
  session_starter:
    parameters:
      load_conversation_history: true
      max_history_messages: 10
      load_session_history: true
      max_session_history: 3
      filter_system_messages: true
      load_user_profile: true
    config:
      user_profile_fields:
      - name
      - language_preference
      - tier
  state_machine:
    parameters:
      use_rules_engine: true
      max_attempts_before_handoff: 3
      reset_on_gratitude: true
    config:
      default_state: INITIAL
      state_actions:
        INITIAL: auto_reply
        CLARIFY: auto_reply
        LOW_CONFIDENCE: auto_reply
        EMPATHY_MODE: auto_reply
        REPEATED_ISSUE: auto_reply
        STUCK_LOOP: suggest_handoff
        ESCALATE: handoff
        RESOLVED: auto_reply
        BLOCKED: block
