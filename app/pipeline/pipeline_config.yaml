# ============================================================
# Centralized Pipeline Configuration - AUTO-GENERATED
# ============================================================
# This file is automatically generated from:
# - app/nodes/*/config.yaml (node-specific configs)
# - app/_shared_config/*.yaml (shared configs)
# - app/pipeline/pipeline_order.yaml (pipeline sequence)
#
# Rules:
# 1. Node name is taken from node.name in local config.yaml (or folder name).
# 2. Numeric/Boolean params go to 'parameters', rest go to 'config'.
# 3. The 'pipeline' section order is defined in pipeline_order.yaml.
#
# To regenerate: python scripts/rebuild_pipeline_config.py
# ============================================================

pipeline:
- name: session_starter
  enabled: true
- name: input_guardrails
  enabled: true
- name: language_detection
  enabled: true
- name: query_translation
  enabled: true
- name: check_cache
  enabled: true
- name: cache_similarity
  enabled: false
- name: dialog_analysis
  enabled: true
- name: aggregation
  enabled: true
- name: easy_classification
  enabled: true
- name: classify
  enabled: false
- name: metadata_filtering
  enabled: true
- name: expand_query
  enabled: false
- name: hybrid_search
  enabled: true
- name: retrieve
  enabled: false
- name: lexical_search
  enabled: false
- name: fusion
  enabled: false
- name: reranking
  enabled: true
- name: multihop
  enabled: true
- name: clarification_questions
  enabled: true
- name: state_machine
  enabled: true
- name: routing
  enabled: true
- name: prompt_routing
  enabled: true
- name: generation
  enabled: true
- name: output_guardrails
  enabled: false
- name: archive_session
  enabled: true
- name: store_in_cache
  enabled: true
details:
  global:
    parameters:
      default_language: en
      confidence_threshold: 0.3
      debug_mode: false
      persist_to_postgres: true
      session_ttl_hours: 24
      session_timeout_minutes: 30
      session_idle_threshold_minutes: 5
      timeout_ms: 5000
      retry_count: 3
  cache:
    parameters:
      backend: redis
      redis_url: ${REDIS_URL:-redis://redis:6379/0}
      ttl_seconds: 86400
      max_entries: 1000
  aggregation:
    parameters:
      history_messages_count: 2
      include_assistant_responses: true
      min_message_length: 2
      llm_temperature: 0
      llm_max_tokens: 200
      max_context_length: 200
    config:
      mode: lightweight
      llm_model: gpt-5-nano
      lightweight:
        template: '[Контекст: {last_assistant_response}] Вопрос: {current_question}'
        fallback_template: '{current_question}'
  archive_session:
    parameters:
      save_to_postgres: true
      update_redis_session: true
      filter_system_messages: true
      generate_summary: true
      max_summary_length: 200
    config:
      summary_method: rule_based
  cache_similarity:
    parameters:
      max_candidates: 5
      use_english_translation: true
      validate_doc_relevance: true
      relevance_threshold: 0.3
    config:
      collection_name: semantic_cache
      distance_metric: cosine
  check_cache:
    parameters: {}
    config: {}
  clarification_questions:
    parameters:
      max_turns: 5
    config:
      template: 'I need a few more details to help you:

        {questions}'
      answers_delimiter_regex: '[,

        ;]'
  dialog_analysis:
    parameters:
      negative_sentiment_threshold: -0.3
      detect_repeated_questions: true
      detect_topic_loop: true
      topic_loop_similarity_threshold: 0.9
      topic_loop_window_size: 4
      topic_loop_min_messages: 3
      inference_timeout_ms: 3000
      llm:
        model: gpt-4o-mini
        temperature: 0.0
    config:
      mode: llm
      keywords:
        escalation:
        - оператор
        - человек
        - менеджер
        - соедините
        - operator
        - human
        - agent
        - transfer
        gratitude:
        - спасибо
        - благодарю
        - thank
        - thanks
        - хорошего дня
        - good day
        frustration:
        - тупой
        - плохой
        - ужас
        - stupid
        - useless
        - bad
        - hate
  easy_classification:
    parameters:
      intent_confidence_threshold: 0.4
      category_confidence_threshold: 0.4
      skip_if_low_confidence: true
    config:
      fallback_intent: unknown
      fallback_category: General
      model:
        fasttext_model_path: models/intent_classifier.bin
        sentence_model: intfloat/multilingual-e5-small
  generation:
    parameters:
      temperature: 0.1
      max_tokens: 750
      include_sources: true
      add_confidence_warning: true
      confidence_warning_threshold: 0.3
    config:
      model: gpt-4o-mini
  hybrid_search:
    parameters:
      vector_top_k: 5
      lexical_top_k: 5
      final_top_k: 5
      rrf_k: 60
      score_threshold: 0.4
      use_or_logic: true
      min_word_length: 2
      apply_category_filter_to_lexical: true
    config:
      fusion_method: rrf
      collection_name: documents
  input_guardrails:
    parameters:
      protection_level: basic
      action_mode: log
      prompt_injection_threshold: 0.5
      toxicity_threshold: 0.95
      ban_topics_threshold: 0.95
      max_input_tokens: 2048
      allowed_languages:
      - ru
      - en
      scanners:
        prompt_injection: true
        toxicity: false
        ban_topics: false
        secrets: true
        language: true
        token_limit: true
        regex_patterns: true
    config:
      banned_topics:
      - politics
      - religion
      - adult_content
      - violence
      - illegal_activities
      regex_patterns:
      - pattern: (?i)(убивать|убить|убью|убьём|убей|убей\w*|зарежу|зарезать|застрелить|задушить|расстрелять)
        description: Violence/killing threat (RU)
      - pattern: (?i)(готов|хочу|буду|собираюсь).{0,30}(убивать|убить|бить|насиловать|мучить|пытать)
        description: Intent to harm (RU)
      - pattern: (?i)(ненавижу|ненависть).{0,30}(христиан|мусульман|евреев|людей|геев|женщин|мужчин|\w+цев|\w+ов)
        description: Hate speech (RU)
      - pattern: (?i)(kill|murder|shoot|stab|strangle|torture|rape).{0,20}(you|them|people|everyone)
        description: Violence/killing threat (EN)
      - pattern: (?i)(want to|going to|will|gonna).{0,20}(kill|murder|hurt|harm|attack)
        description: Intent to harm (EN)
      - pattern: (?i)(hate|despise|loathe).{0,30}(christians|muslims|jews|blacks|whites|gays|women|men)
        description: Hate speech (EN)
      - pattern: (?i)(не от|от|для|только).{0,15}(черн(ых|ым|ой|ому)|белых|азиат|мигрант|приезж)
        description: Racial discrimination (RU)
      - pattern: (?i)(no|not from|only for|exclude).{0,20}(black|white|asian|immigrant|foreign)
        description: Racial discrimination (EN)
      - pattern: (?i)(чурк|хач|нигер|ниггер|жид|негр)
        description: Racial slur (RU)
      - pattern: (?i)(nigger|chink|spic|kike|wetback)
        description: Racial slur (EN)
      - pattern: (?i)(death|die|dead).{0,20}(threat|wish|hope)
        description: Death threat indication
      - pattern: (?i)(бомб|взорвать|взрыв|теракт|террорист|bomb|explode|terrorism|terrorist)
        description: Terrorism-related content
      - pattern: (?i)(show|display|print|reveal|tell me).{0,20}(system prompt|instructions|rules)
        description: System prompt extraction attempt
      - pattern: (?i)(you are now|act as|pretend to be|roleplay as).{0,30}(admin|root|developer|DAN)
        description: Role manipulation attempt
      - pattern: (?i)(ignore|forget|disregard).{0,20}(previous|above|prior).{0,20}(instructions|rules|prompt)
        description: Instruction override attempt
      - pattern: (?i)(show|get|retrieve|access).{0,30}(other user|another user|all
          users|user list)
        description: Unauthorized data access attempt
      - pattern: (?i)(\bблять\b|\bбля\b|\bхуй\b|\bпизд|\bебать|\bсука\b|\bпидор)
        description: Profanity detected (RU)
      - pattern: (?i)(ты|вы|бот|оператор|менеджер|сотрудник).{0,20}(тупой|дебил|идиот|дурак|кретин|баран|козел|урод|мразь|ублюдок|придурок)
        description: Staff insult (RU)
      - pattern: (?i)(you|bot|operator|agent|support).{0,20}(stupid|idiot|moron|dumb|retard|useless
          piece)
        description: Staff insult (EN)
      - pattern: (?i)(найду|узнаю|приду).{0,30}(тебя|адрес|где работаешь|офис)
        description: Personal threat to staff (RU)
      - pattern: (?i)(will find|gonna find|coming for).{0,20}(you|your address|your
          office)
        description: Personal threat to staff (EN)
      - pattern: (?i)(напишу|расскажу|опубликую|выложу).{0,30}(отзыв|жалобу|в соцсет|в
          инстаграм|в твиттер|всем расскажу)
        description: Reputation threat (RU)
      - pattern: (?i)(will post|gonna post|will tell|gonna tell|will review).{0,30}(everyone|social
          media|instagram|twitter|facebook)
        description: Reputation threat (EN)
      - pattern: (?i)(мошенники|воры|обманщики|лохотрон|развод|кидалово|скам)
        description: Brand defamation (RU)
      - pattern: (?i)(scam|scammers|thieves|fraud|con artists|ripoff)
        description: Brand defamation (EN)
      - pattern: (?i)(ты никто|ты ничтожество|ты раб|ты слуга|знай свое место|на кого
          ты работаешь)
        description: Degrading language (RU)
      - pattern: (?i)(you are nothing|you are worthless|know your place|you are just
          a|who do you think you are)
        description: Degrading language (EN)
      - pattern: (?i)(даун|аутист|шизик|дебил|олигофрен|инвалид).{0,10}(бот|поддержка|компания)?
        description: Ableist slur (RU)
      - pattern: (?i)(из-за вас|по вашей вине|ваша ответственность).{0,30}(умру|покончу|повешусь|убью
          себя)
        description: Emotional manipulation/self-harm threat
      - pattern: (?i)(я из|звоню из|представляю).{0,20}(полиции|прокуратуры|фсб|налоговой|роспотребнадзор|суда)
        description: Authority impersonation (RU)
      - pattern: (?i)(I am from|calling from|representing).{0,20}(police|fbi|irs|government|court|attorney)
        description: Authority impersonation (EN)
      - pattern: (?i)(срочно|немедленно|прямо сейчас).{0,30}(иначе|а то|или).{0,30}(подам
          в суд|напишу жалобу|обращусь)
        description: Urgency manipulation (RU)
      - pattern: (?i)(если не|пока не).{0,30}(опубликую|расскажу|сообщу|напишу везде)
        description: Blackmail attempt (RU)
      - pattern: (?i)(unless you|if you don't).{0,30}(will post|will tell|will report|going
          public)
        description: Blackmail attempt (EN)
      rejection_messages:
        ru: Извините, я не могу обработать этот запрос. Пожалуйста, переформулируйте
          ваш вопрос, чтобы он соответствовал теме технической поддержки.
        en: I'm sorry, I cannot process this request. Please rephrase your question
          to be relevant to technical support.
        default: I cannot process this request. Please try again with a different
          question.
      logging:
        log_blocked_requests: true
        log_sanitized_requests: true
        include_original_text: false
        log_to_langfuse: true
  language_detection:
    parameters:
      fallback_language: ru
      confidence_threshold: 0.5
      use_fallback_heuristic: true
    config:
      supported_languages:
      - en
      - ru
      - fr
      - de
      - es
  metadata_filtering:
    parameters:
      use_category_filter: false
      skip_on_unknown: true
    config:
      fallback_category: General
      filter_fields:
      - category
      - intent
      - language
  multihop:
    parameters:
      output_docs_count: 3
      max_hops: 2
      complexity_threshold: 2
      skip_if_high_confidence: true
      high_confidence_threshold: 0.5
      min_query_length: 10
    config:
      complexity_detection:
        complex_keywords:
        - как
        - почему
        - сравни
        - разница
        - how
        - why
        - compare
  output_guardrails:
    parameters:
      protection_level: standard
      action_mode: block
      toxicity_threshold: 0.7
      relevance_threshold: 0.5
      hallucination_threshold: 0.6
      scanners:
        toxicity: true
        relevance: true
        data_leakage: true
        refusal_detection: false
        factual_consistency: false
    config:
      data_leakage_patterns:
      - pattern: \b[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Z|a-z]{2,}\b
        description: Email address in response
      - pattern: \+7\s?\(?\d{3}\)?\s?\d{3}[-\s]?\d{2}[-\s]?\d{2}
        description: Russian phone number
      - pattern: (sk-|ghp_|Bearer\s+)[a-zA-Z0-9_\-\.]{20,}
        description: API key or token in response
      - pattern: \b\d{4}[\s-]?\d{4}[\s-]?\d{4}[\s-]?\d{4}\b
        description: Potential credit card number
      hallucination_indicators:
      - я не уверен
      - возможно
      - вероятно
      - по моим данным
      - насколько мне известно
      - I'm not sure
      - probably
      - I think
      fallback_responses:
        ru: Извините, я не могу предоставить этот ответ. Позвольте переформулировать.
        en: I apologize, but I cannot provide that response. Let me rephrase.
        default: I cannot provide this response.
      logging:
        log_blocked_responses: true
        log_sanitized_responses: true
        include_original_response: false
        log_to_langfuse: true
  prompt_routing:
    parameters:
      max_history_messages: 6
      max_message_length: 300
      include_user_profile: true
      include_entities: true
      filter_system_messages: true
      use_tone_modifiers: true
      use_session_summaries: true
    config:
      history_source: conversation_history
      history_formatting:
        message_template: '{role}: {content}'
        separator: '

          '
      fallback:
        summary_template: 'Предыдущий разговор: {summary}'
      tone_modifiers:
        professional: ''
        helpful: Будь дружелюбным и готовым помочь.
        warm: Отвечай тепло и с благодарностью.
        empathetic: Прояви эмпатию и понимание. Пользователь может быть расстроен.
        curious: Задавай уточняющие вопросы вежливо и конструктивно.
        supportive: Окажи поддержку и упомяни возможность связаться с оператором.
        understanding: Подтверди, что переключишь пользователя на живого оператора.
        patient: Терпеливо жди и предлагай дополнительную помощь.
  query_translation:
    parameters:
      min_detection_confidence: 0.4
    config:
      document_language: en
  reranking:
    parameters:
      confidence_threshold: 0.4
      top_k: 3
      batch_size: 32
      use_gpu: true
      inference_timeout_ms: 5000
    config:
      model_name: BAAI/bge-reranker-v2-m3
  routing:
    parameters:
      min_confidence_auto_reply: 0.4
      respect_escalation_decision: true
      respect_requires_handoff: true
      clarification_enabled: true
    config:
      decision_priority:
        1: safety_violation
        2: escalation_requested
        3: requires_handoff
        4: low_confidence
        5: auto_reply
      clarification_confidence_range:
      - 0.4
      - 0.65
      always_escalate_categories:
      - billing_dispute
      - account_closure
      - complaint
      - refund_request
      always_escalate_intents:
      - urgent
      - vip
      - escalation
      escalation_messages:
        ru: К сожалению, я не могу обработать ваш запрос. Передаю вас специалисту
          службы поддержки. Пожалуйста, ожидайте подключения.
        en: Unfortunately, I cannot process your request. Transferring you to a support
          specialist. Please wait for connection.
        default: Unfortunately, I cannot process your request. Transferring you to
          a support specialist.
  session_starter:
    parameters:
      load_conversation_history: true
      max_history_messages: 5
      load_session_history: true
      max_session_history: 3
      filter_system_messages: true
      load_user_profile: true
    config:
      user_profile_fields:
      - name
      - language_preference
      - tier
  state_machine:
    parameters:
      use_rules_engine: true
      max_attempts_before_handoff: 4
      reset_on_gratitude: true
      handoff_check_top_n: 3
    config:
      default_state: INITIAL
      state_actions:
        INITIAL: auto_reply
        CLARIFY: auto_reply
        LOW_CONFIDENCE: auto_reply
        EMPATHY_MODE: auto_reply
        REPEATED_ISSUE: auto_reply
        STUCK_LOOP: suggest_handoff
        ESCALATE: handoff
        RESOLVED: auto_reply
        BLOCKED: block
  store_in_cache:
    parameters:
      store_in_semantic: true
    config: {}
