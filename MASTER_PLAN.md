# –ú–ê–°–¢–ï–†-–ü–õ–ê–ù: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ STUCK_LOOP –∏ –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã

## üéØ –¶–µ–ª—å
–†–µ—à–∏—Ç—å –≤—Å–µ –Ω–∞–π–¥–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã:
1. ‚ùå STUCK_LOOP —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –ª–æ–∂–Ω–æ (—Ä–∞–∑–Ω—ã–µ —Ç–µ–º—ã –æ–ø—Ä–µ–¥–µ–ª—è—é—Ç—Å—è –∫–∞–∫ –ø–µ—Ç–ª—è)
2. ‚ùå Cache similarity –≤—Å—Ç—Ä–æ–µ–Ω –≤ check_cache (–Ω–µ–ª—å–∑—è –æ—Ç–∫–ª—é—á–∏—Ç—å)
3. ‚ùå –õ–æ–≥–∏–∫–∞ –∫–µ—à–∞ –≤ `app/cache/` –≤–º–µ—Å—Ç–æ `app/services/`
4. ‚ùå –ù–æ–¥—ã –∫–µ—à–∞ –Ω–µ —Å–ª–µ–¥—É—é—Ç –ø–∞—Ç—Ç–µ—Ä–Ω—É `app/nodes/*/`
5. ‚ùå `conversation_history` —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω—è–µ—Ç—Å—è –Ω–∞ –≤—Å–µ —É–∑–ª—ã (–ª–∏—à–Ω–∏–π overhead)
6. ‚ùå –ü–µ—Ä–µ–≤–æ–¥—ã –Ω–µ –∫–µ—à–∏—Ä—É—é—Ç—Å—è (–ª–∞—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å –ø—Ä–∏ –±–æ–ª—å—à–æ–π –∏—Å—Ç–æ—Ä–∏–∏)
7. ‚ùå State machine –∏–º–µ–µ—Ç –Ω–µ–≤–∞–ª–∏–¥–Ω–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ `suggest_handoff`

---

## üìã –ü–û–õ–ù–´–ô –ü–õ–ê–ù –ò–ó–ú–ï–ù–ï–ù–ò–ô

### –§–ê–ó–ê 1: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ State Machine (–ö–†–ò–¢–ò–ß–ù–û)
**–¶–µ–ª—å**: –ò—Å–ø—Ä–∞–≤–∏—Ç—å –Ω–µ–≤–∞–ª–∏–¥–Ω–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ –≤ rules.yaml

#### 1.1. –ò—Å–ø—Ä–∞–≤–∏—Ç—å STUCK_LOOP action
- **–§–∞–π–ª**: `app/nodes/state_machine/rules.yaml`
- **–ò–∑–º–µ–Ω–µ–Ω–∏–µ**: `action: suggest_handoff` ‚Üí `action: handoff`
- **–ü—Ä–∏—á–∏–Ω–∞**: `suggest_handoff` –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è routing node
- **–°—Ç–∞—Ç—É—Å**: ‚úÖ –í–´–ü–û–õ–ù–ï–ù–û

---

### –§–ê–ó–ê 2: Loop Detector - Translation-Based Approach
**–¶–µ–ª—å**: –£—Å—Ç—Ä–∞–Ω–∏—Ç—å –ª–æ–∂–Ω—ã–µ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏—è –¥–µ—Ç–µ–∫—Ç–æ—Ä–∞ –ø–µ—Ç–µ–ª—å

#### 2.1. –ü–µ—Ä–µ–ø–∏—Å–∞—Ç—å loop_detector.py
- **–§–∞–π–ª**: `app/nodes/dialog_analysis/loop_detector.py`
- **–ò–∑–º–µ–Ω–µ–Ω–∏—è**:
  - –î–æ–±–∞–≤–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã `translated_query`, `detected_language`
  - –ü–µ—Ä–µ–≤–æ–¥–∏—Ç—å –≤—Å–µ –≤–æ–ø—Ä–æ—Å—ã –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–∏–π –ø–µ—Ä–µ–¥ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ–º
  - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å embeddings –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–æ–º —Ç–µ–∫—Å—Ç–µ
  - –ü–æ–≤—ã—Å–∏—Ç—å –ø–æ—Ä–æ–≥ –¥–æ 0.85
  - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–µ—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø–µ—Ä–µ–≤–æ–¥—ã –∏–∑ `metadata.translated`
- **–°—Ç–∞—Ç—É—Å**: ‚úÖ –í–´–ü–û–õ–ù–ï–ù–û

#### 2.2. –û–±–Ω–æ–≤–∏—Ç—å –≤—ã–∑–æ–≤ –¥–µ—Ç–µ–∫—Ç–æ—Ä–∞
- **–§–∞–π–ª—ã**: 
  - `app/nodes/dialog_analysis/llm.py`
  - `app/nodes/dialog_analysis/node.py` (–µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è)
- **–ò–∑–º–µ–Ω–µ–Ω–∏—è**:
  - –ü–µ—Ä–µ–¥–∞–≤–∞—Ç—å `translated_query` –∏ `detected_language` –∏–∑ state
  - –û–±–Ω–æ–≤–∏—Ç—å –ø–æ—Ä–æ–≥ –¥–æ 0.85
- **–°—Ç–∞—Ç—É—Å**: ‚úÖ –í–´–ü–û–õ–ù–ï–ù–û (llm.py)

#### 2.3. –û–±–Ω–æ–≤–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
- **–§–∞–π–ª**: `app/nodes/dialog_analysis/config.yaml`
- **–ò–∑–º–µ–Ω–µ–Ω–∏–µ**: `topic_loop_similarity_threshold: 0.85`
- **–°—Ç–∞—Ç—É—Å**: ‚úÖ –í–´–ü–û–õ–ù–ï–ù–û

---

### –§–ê–ó–ê 3: –ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –ü–µ—Ä–µ–≤–æ–¥–æ–≤
**–¶–µ–ª—å**: –£—Å—Ç—Ä–∞–Ω–∏—Ç—å –ª–∞—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –±–æ–ª—å—à–æ–π –∏—Å—Ç–æ—Ä–∏–∏

#### 3.1. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–µ—Ä–µ–≤–æ–¥–æ–≤ –≤ –ë–î
- **–§–∞–π–ª**: `app/nodes/archive_session/node.py`
- **–ò–∑–º–µ–Ω–µ–Ω–∏—è**:
  - –î–æ–±–∞–≤–∏—Ç—å `"translated": state.get("translated_query")` –≤ metadata –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
- **–°—Ç–∞—Ç—É—Å**: ‚úÖ –í–´–ü–û–õ–ù–ï–ù–û

#### 3.2. –ó–∞–≥—Ä—É–∑–∫–∞ –ø–µ—Ä–µ–≤–æ–¥–æ–≤ –∏–∑ –ë–î
- **–§–∞–π–ª**: `app/nodes/session_starter/node.py`
- **–ò–∑–º–µ–Ω–µ–Ω–∏—è**:
  - –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ `conversation_history` –≤–∫–ª—é—á–∞–µ—Ç metadata
  - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ `PersistenceManager.get_conversation_history()` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç metadata
- **–°—Ç–∞—Ç—É—Å**: ‚úÖ –í–´–ü–û–õ–ù–ï–ù–û (–ø—Ä–æ–≤–µ—Ä–µ–Ω–æ: get_session_messages –∑–∞–≥—Ä—É–∂–∞–µ—Ç metadata)

#### 3.3. –ú–∏–≥—Ä–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
- **–¶–µ–ª—å**: –î–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä–µ–≤–æ–¥—ã –∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º —Å–æ–æ–±—â–µ–Ω–∏—è–º –≤ –ë–î
- **–§–∞–π–ª**: `scripts/migrate_add_translations.py`
- **–°—Ç–∞—Ç—É—Å**: ‚úÖ –í–´–ü–û–õ–ù–ï–ù–û (—Å–∫—Ä–∏–ø—Ç —Å–æ–∑–¥–∞–Ω, –≥–æ—Ç–æ–≤ –∫ –∑–∞–ø—É—Å–∫—É)

---

### –§–ê–ó–ê 4: –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è State
**–¶–µ–ª—å**: –£–º–µ–Ω—å—à–∏—Ç—å —Ä–∞–∑–º–µ—Ä state, —É–±—Ä–∞—Ç—å –ª–∏—à–Ω–µ–µ —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö

#### 4.1. –ò–∑–º–µ–Ω–∏—Ç—å reducer –¥–ª—è conversation_history
- **–§–∞–π–ª**: `app/pipeline/state.py`
- **–ò–∑–º–µ–Ω–µ–Ω–∏–µ**: `add_messages` ‚Üí `overwrite`
- **–ü—Ä–∏—á–∏–Ω–∞**: –ò—Å—Ç–æ—Ä–∏—è –Ω–µ –¥–æ–ª–∂–Ω–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω—è—Ç—å—Å—è –Ω–∞ –≤—Å–µ —É–∑–ª—ã
- **–°—Ç–∞—Ç—É—Å**: ‚úÖ –í–´–ü–û–õ–ù–ï–ù–û

---

### –§–ê–ó–ê 5: –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ Cache ‚Üí Services
**–¶–µ–ª—å**: –ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫—É –∫–µ—à–∞ –≤ services, —Å–æ–∑–¥–∞—Ç—å –æ—Ç–¥–µ–ª—å–Ω—ã–µ –Ω–æ–¥—ã

#### 5.1. –°–æ–∑–¥–∞—Ç—å app/services/cache/
- **–°—Ç—Ä—É–∫—Ç—É—Ä–∞**:
  ```
  app/services/cache/
  ‚îú‚îÄ‚îÄ __init__.py
  ‚îú‚îÄ‚îÄ manager.py      # CacheManager (–∏–∑ cache_layer.py)
  ‚îú‚îÄ‚îÄ session.py      # SessionManager (–∏–∑ session_manager.py)
  ‚îî‚îÄ‚îÄ similarity.py   # NEW: Similarity check logic
  ```
- **–î–µ–π—Å—Ç–≤–∏—è**:
  - [x] –°–æ–∑–¥–∞—Ç—å –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é `app/services/cache/`
  - [x] –ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å `CacheManager` –∏–∑ `app/cache/cache_layer.py` ‚Üí `app/services/cache/manager.py`
  - [x] –ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å `SessionManager` –∏–∑ `app/cache/session_manager.py` ‚Üí `app/services/cache/session.py`
  - [x] –°–æ–∑–¥–∞—Ç—å `app/services/cache/similarity.py` —Å —Ñ—É–Ω–∫—Ü–∏–µ–π `check_semantic_similarity()`
  - [x] –°–æ–∑–¥–∞—Ç—å `app/services/cache/__init__.py` —Å —ç–∫—Å–ø–æ—Ä—Ç–∞–º–∏
- **–°—Ç–∞—Ç—É—Å**: ‚úÖ –í–´–ü–û–õ–ù–ï–ù–û

#### 5.2. –°–æ–∑–¥–∞—Ç—å app/nodes/check_cache/
- **–°—Ç—Ä—É–∫—Ç—É—Ä–∞**:
  ```
  app/nodes/check_cache/
  ‚îú‚îÄ‚îÄ __init__.py
  ‚îú‚îÄ‚îÄ node.py         # CheckCacheNode(BaseNode)
  ‚îî‚îÄ‚îÄ config.yaml
  ```
- **node.py**:
  ```python
  from app.nodes.base_node import BaseNode
  from app.services.cache.manager import CacheManager
  
  class CheckCacheNode(BaseNode):
      async def execute(self, state):
          # –¢–æ–ª—å–∫–æ exact match –ø—Ä–æ–≤–µ—Ä–∫–∞
          # –ë–ï–ó similarity check
  ```
- **config.yaml**:
  ```yaml
  node:
    name: check_cache
    enabled: true
  
  parameters:
    ttl_seconds: 3600
    use_embeddings: true
  ```
- **–î–µ–π—Å—Ç–≤–∏—è**:
  - [x] –°–æ–∑–¥–∞—Ç—å –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –∏ —Ñ–∞–π–ª—ã
  - [x] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å CheckCacheNode
  - [x] –£–±—Ä–∞—Ç—å similarity check –∏–∑ –ª–æ–≥–∏–∫–∏
  - [x] –°–æ–∑–¥–∞—Ç—å evaluator.py
  - [x] –ò—Å–ø—Ä–∞–≤–∏—Ç—å config.yaml –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è shared config
- **–°—Ç–∞—Ç—É—Å**: ‚úÖ –í–´–ü–û–õ–ù–ï–ù–û

#### 5.3. –°–æ–∑–¥–∞—Ç—å app/nodes/store_in_cache/
- **–°—Ç—Ä—É–∫—Ç—É—Ä–∞**:
  ```
  app/nodes/store_in_cache/
  ‚îú‚îÄ‚îÄ __init__.py
  ‚îú‚îÄ‚îÄ node.py         # StoreInCacheNode(BaseNode)
  ‚îî‚îÄ‚îÄ config.yaml
  ```
- **node.py**:
  ```python
  from app.nodes.base_node import BaseNode
  from app.services.cache.manager import CacheManager
  
  class StoreInCacheNode(BaseNode):
      async def execute(self, state):
          # –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –∫–µ—à
          # –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ translated_query –≤ metadata
  ```
- **–î–µ–π—Å—Ç–≤–∏—è**:
  - [x] –°–æ–∑–¥–∞—Ç—å –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –∏ —Ñ–∞–π–ª—ã
  - [x] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å StoreInCacheNode
  - [x] –°–æ—Ö—Ä–∞–Ω—è—Ç—å `translated_query` –≤ cache metadata
  - [x] –°–æ–∑–¥–∞—Ç—å evaluator.py
  - [x] –ò—Å–ø—Ä–∞–≤–∏—Ç—å config.yaml –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è shared config
- **–°—Ç–∞—Ç—É—Å**: ‚úÖ –í–´–ü–û–õ–ù–ï–ù–û

#### 5.4. –°–æ–∑–¥–∞—Ç—å app/nodes/cache_similarity/ (–ù–û–í–ê–Ø –ù–û–î–ê)
- **–°—Ç—Ä—É–∫—Ç—É—Ä–∞**:
  ```
  app/nodes/cache_similarity/
  ‚îú‚îÄ‚îÄ __init__.py
  ‚îú‚îÄ‚îÄ node.py         # CacheSimilarityNode(BaseNode)
  ‚îî‚îÄ‚îÄ config.yaml
  ```
- **node.py**:
  ```python
  from app.nodes.base_node import BaseNode
  from app.services.cache.similarity import check_semantic_similarity
  
  class CacheSimilarityNode(BaseNode):
      async def execute(self, state):
          # Semantic similarity check
          # –ò—Å–ø–æ–ª—å–∑—É–µ—Ç translated_query –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
          # –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç cache_hit=True –µ—Å–ª–∏ –Ω–∞–π–¥–µ–Ω–æ –ø–æ—Ö–æ–∂–µ–µ
  ```
- **config.yaml**:
  ```yaml
  node:
    name: cache_similarity
    enabled: false  # –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –≤—ã–∫–ª—é—á–µ–Ω–∞
  
  parameters:
    similarity_threshold: 0.92
    max_candidates: 5
    use_english_translation: true  # –°—Ä–∞–≤–Ω–∏–≤–∞—Ç—å –ø–µ—Ä–µ–≤–æ–¥—ã
  ```
- **–î–µ–π—Å—Ç–≤–∏—è**:
  - [x] –°–æ–∑–¥–∞—Ç—å –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –∏ —Ñ–∞–π–ª—ã
  - [x] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å CacheSimilarityNode
  - [x] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å `app/services/cache/similarity.py`
  - [x] –°–æ–∑–¥–∞—Ç—å evaluator.py
  - [x] –ò—Å–ø—Ä–∞–≤–∏—Ç—å config.yaml –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è shared config
- **–°—Ç–∞—Ç—É—Å**: ‚úÖ –í–´–ü–û–õ–ù–ï–ù–û

#### 5.5. –û–±–Ω–æ–≤–∏—Ç—å graph.py
- **–§–∞–π–ª**: `app/pipeline/graph.py`
- **–ò–∑–º–µ–Ω–µ–Ω–∏—è**:
  - –û–±–Ω–æ–≤–∏—Ç—å –∏–º–ø–æ—Ä—Ç—ã:
    ```python
    from app.nodes.check_cache.node import check_cache_node
    from app.nodes.store_in_cache.node import store_in_cache_node
    from app.nodes.cache_similarity.node import cache_similarity_node  # NEW
    ```
  - –û–±–Ω–æ–≤–∏—Ç—å `NODE_FUNCTIONS`:
    ```python
    NODE_FUNCTIONS = {
        "check_cache": check_cache_node,
        "store_in_cache": store_in_cache_node,
        "cache_similarity": cache_similarity_node,  # NEW
        ...
    }
    ```
- **–°—Ç–∞—Ç—É—Å**: ‚úÖ –í–´–ü–û–õ–ù–ï–ù–û

#### 5.6. –£–¥–∞–ª–∏—Ç—å app/cache/ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
- **–î–µ–π—Å—Ç–≤–∏—è**:
  - [x] –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –≤—Å–µ –∏–º–ø–æ—Ä—Ç—ã –æ–±–Ω–æ–≤–ª–µ–Ω—ã (—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –æ–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å)
  - [x] –°–æ–∑–¥–∞—Ç—å `app/cache/DEPRECATED.md` —Å —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ–º –ø–æ –º–∏–≥—Ä–∞—Ü–∏–∏
  - [x] –û–±–Ω–æ–≤–∏—Ç—å `app/cache/__init__.py` –¥–ª—è —Ä–µ—ç–∫—Å–ø–æ—Ä—Ç–∞ —Å deprecated warning
  - [x] –°–æ–∑–¥–∞—Ç—å `scripts/cleanup_deprecated_cache.py` –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ —É–¥–∞–ª–µ–Ω–∏—è
  - [ ] –ó–∞–ø—É—Å—Ç–∏—Ç—å cleanup (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –ø–æ—Å–ª–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è)
- **–°—Ç–∞—Ç—É—Å**: ‚úÖ –í–´–ü–û–õ–ù–ï–ù–û (—Å–∫—Ä–∏–ø—Ç –≥–æ—Ç–æ–≤, –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω–æ –∫ cleanup)

---

### –§–ê–ó–ê 6: –ò–∑–º–µ–Ω–µ–Ω–∏–µ –ü–æ—Ä—è–¥–∫–∞ –ù–æ–¥
**–¶–µ–ª—å**: –û–±–µ—Å–ø–µ—á–∏—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –¥–ª—è translation-based –ø–æ–¥—Ö–æ–¥–∞

#### 6.1. –û–±–Ω–æ–≤–∏—Ç—å pipeline_config.yaml
- **–§–∞–π–ª**: `app/pipeline/pipeline_config.yaml`
- **–¢–µ–∫—É—â–∏–π –ø–æ—Ä—è–¥–æ–∫** (–ø—Ä–æ–≤–µ—Ä–∏—Ç—å):
  ```yaml
  pipeline:
    - session_starter
    - input_guardrails
    - dialog_analysis      # ‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û - –Ω–µ—Ç –ø–µ—Ä–µ–≤–æ–¥–æ–≤
    - language_detection
    - query_translation
    - ...
  ```
- **–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫**:
  ```yaml
  pipeline:
    - session_starter
    - input_guardrails
    - language_detection   # 1. –û–ø—Ä–µ–¥–µ–ª—è–µ–º —è–∑—ã–∫
    - query_translation    # 2. –ü–µ—Ä–µ–≤–æ–¥–∏–º –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–∏–π
    - check_cache          # 3. –ü—Ä–æ–≤–µ—Ä—è–µ–º exact match
    - cache_similarity     # 4. –ü—Ä–æ–≤–µ—Ä—è–µ–º semantic similarity (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
    - dialog_analysis      # 5. –ò—Å–ø–æ–ª—å–∑—É–µ–º translated_query –¥–ª—è loop detection
    - aggregation
    - lexical_search
    - retrieve
    - fusion
    - reranking
    - state_machine
    - routing
    - prompt_routing
    - generation
    - output_guardrails
    - archive_session
    - store_in_cache
  ```
- **–°—Ç–∞—Ç—É—Å**: ‚úÖ –í–´–ü–û–õ–ù–ï–ù–û

#### 6.2. –û–±–Ω–æ–≤–∏—Ç—å pipeline_order.yaml
- **–§–∞–π–ª**: `app/pipeline/pipeline_order.yaml`
- **–ò–∑–º–µ–Ω–µ–Ω–∏—è**: –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Å pipeline_config.yaml
- **–°—Ç–∞—Ç—É—Å**: ‚úÖ –í–´–ü–û–õ–ù–ï–ù–û

---

### –§–ê–ó–ê 7: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π –ù–æ–¥
**–¶–µ–ª—å**: –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–µ –Ω–æ–¥—ã –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é

#### 7.1. –î–æ–±–∞–≤–∏—Ç—å cache_similarity –≤ pipeline_config.yaml
- **–§–∞–π–ª**: `app/pipeline/pipeline_config.yaml`
- **–î–æ–±–∞–≤–∏—Ç—å**:
  ```yaml
  - name: cache_similarity
    enabled: false  # –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –≤—ã–∫–ª—é—á–µ–Ω–∞
    description: "Semantic similarity check against cached queries"
  ```
- **–°—Ç–∞—Ç—É—Å**: ‚è≥ TODO

---

### –§–ê–ó–ê 8: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –í–∞–ª–∏–¥–∞—Ü–∏—è
**–¶–µ–ª—å**: –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –≤—Å–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

#### 8.1. Unit —Ç–µ—Å—Ç—ã
- **–§–∞–π–ª—ã** (—Å–æ–∑–¥–∞—Ç—å):
  - `tests/test_loop_detector.py` - —Ç–µ—Å—Ç translation-based –ø–æ–¥—Ö–æ–¥–∞
  - `tests/test_cache_similarity.py` - —Ç–µ—Å—Ç –Ω–æ–≤–æ–π –Ω–æ–¥—ã
  - `tests/test_cache_services.py` - —Ç–µ—Å—Ç services/cache
- **–°—Ç–∞—Ç—É—Å**: ‚è≥ TODO

#### 8.2. Integration —Ç–µ—Å—Ç—ã
- **–¢–µ—Å—Ç 1**: –†–∞–∑–Ω—ã–µ —Ç–µ–º—ã –ù–ï –æ–ø—Ä–µ–¥–µ–ª—è—é—Ç—Å—è –∫–∞–∫ –ø–µ—Ç–ª—è
  ```python
  questions = [
      "–ö–∞–∫ –æ–ø–ª–∞—Ç–∏—Ç—å –∑–∞–∫–∞–∑?",
      "–ö–∞–∫–∏–µ —Å–ø–æ—Å–æ–±—ã –¥–æ—Å—Ç–∞–≤–∫–∏?",
      "–ö–∞–∫ –∑–∞—â–∏—Ç–∏—Ç—å –∞–∫–∫–∞—É–Ω—Ç?"
  ]
  # –û–∂–∏–¥–∞–Ω–∏–µ: loop_detected = False
  ```
- **–¢–µ—Å—Ç 2**: –û–¥–Ω–∞ —Ç–µ–º–∞ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –∫–∞–∫ –ø–µ—Ç–ª—è
  ```python
  questions = [
      "–ö–∞–∫ —Å–±—Ä–æ—Å–∏—Ç—å –ø–∞—Ä–æ–ª—å?",
      "–ù–µ –º–æ–≥—É –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–∞—Ä–æ–ª—å",
      "–ö–∞–∫ –º–Ω–µ —Å–±—Ä–æ—Å–∏—Ç—å —Å–≤–æ–π –ø–∞—Ä–æ–ª—å?"
  ]
  # –û–∂–∏–¥–∞–Ω–∏–µ: loop_detected = True
  ```
- **–¢–µ—Å—Ç 3**: Cache similarity —Ä–∞–±–æ—Ç–∞–µ—Ç —Å –ø–µ—Ä–µ–≤–æ–¥–∞–º–∏
  ```python
  # –ö–µ—à–∏—Ä—É–µ–º: "How to reset password?" (en)
  # –ó–∞–ø—Ä–æ—Å: "–ö–∞–∫ —Å–±—Ä–æ—Å–∏—Ç—å –ø–∞—Ä–æ–ª—å?" (ru)
  # –û–∂–∏–¥–∞–Ω–∏–µ: cache_hit = True (–ø–æ—Å–ª–µ –ø–µ—Ä–µ–≤–æ–¥–∞)
  ```
- **–°—Ç–∞—Ç—É—Å**: ‚è≥ TODO

#### 8.3. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
- **–ú–µ—Ç—Ä–∏–∫–∏**:
  - –õ–∞—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å loop detection: < 100ms (—Å –∫–µ—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–º–∏ –ø–µ—Ä–µ–≤–æ–¥–∞–º–∏)
  - –õ–∞—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å cache similarity: < 150ms
  - –†–∞–∑–º–µ—Ä state: —É–º–µ–Ω—å—à–µ–Ω–∏–µ –Ω–∞ ~30% (–±–µ–∑ auto-propagation conversation_history)
- **–°—Ç–∞—Ç—É—Å**: ‚è≥ TODO

---

### –§–ê–ó–ê 9: –ú–∏–≥—Ä–∞—Ü–∏—è –î–∞–Ω–Ω—ã—Ö (–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
**–¶–µ–ª—å**: –î–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä–µ–≤–æ–¥—ã –∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º —Å–æ–æ–±—â–µ–Ω–∏—è–º

#### 9.1. –°–æ–∑–¥–∞—Ç—å —Å–∫—Ä–∏–ø—Ç –º–∏–≥—Ä–∞—Ü–∏–∏
- **–§–∞–π–ª**: `scripts/migrate_add_translations.py`
- **–õ–æ–≥–∏–∫–∞**:
  ```python
  async def migrate_translations():
      # 1. –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è –±–µ–∑ metadata.translated
      messages = await PersistenceManager.get_messages_without_translation()
      
      # 2. –î–ª—è –∫–∞–∂–¥–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è:
      for msg in messages:
          # –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å —è–∑—ã–∫
          lang = detect_language(msg.content)
          
          # –ü–µ—Ä–µ–≤–µ—Å—Ç–∏ –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–∏–π
          if lang != "en":
              translated = await translate_text(msg.content, target_lang="en")
          else:
              translated = msg.content
          
          # –û–±–Ω–æ–≤–∏—Ç—å metadata
          await PersistenceManager.update_message_metadata(
              msg.id,
              {"translated": translated}
          )
  ```
- **–°—Ç–∞—Ç—É—Å**: ‚è≥ TODO (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

#### 9.2. –ó–∞–ø—É—Å—Ç–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é
- **–ö–æ–º–∞–Ω–¥–∞**: `python scripts/migrate_add_translations.py [--dry-run]`
- **–°—Ç–∞—Ç—É—Å**: ‚è≥ TODO (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –∑–∞–ø—É—Å–∫–∞—Ç—å –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏)

---

### –§–ê–ó–ê 10: –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
**–¶–µ–ª—å**: –û–±–Ω–æ–≤–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é

#### 10.1. –û–±–Ω–æ–≤–∏—Ç—å README
- **–§–∞–π–ª**: `README.md`
- **–î–æ–±–∞–≤–∏—Ç—å**:
  - –û–ø–∏—Å–∞–Ω–∏–µ –Ω–æ–≤—ã—Ö –Ω–æ–¥ (cache_similarity)
  - –û–ø–∏—Å–∞–Ω–∏–µ translation-based loop detection
  - –ü–æ—Ä—è–¥–æ–∫ –Ω–æ–¥ –≤ pipeline
- **–°—Ç–∞—Ç—É—Å**: ‚è≥ TODO

#### 10.2. –°–æ–∑–¥–∞—Ç—å ARCHITECTURE.md
- **–§–∞–π–ª**: `ARCHITECTURE.md`
- **–°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ**:
  - –î–∏–∞–≥—Ä–∞–º–º–∞ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã
  - –û–ø–∏—Å–∞–Ω–∏–µ services/cache
  - –û–ø–∏—Å–∞–Ω–∏–µ –Ω–æ–¥ –∏ –∏—Ö –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è
- **–°—Ç–∞—Ç—É—Å**: ‚è≥ TODO

#### 10.3. –û–±–Ω–æ–≤–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é
- **–§–∞–π–ª—ã**:
  - `LOOP_DETECTOR_TRANSLATION.md` - ‚úÖ –í–´–ü–û–õ–ù–ï–ù–û
  - `CACHE_REFACTORING_PLAN.md` - ‚úÖ –í–´–ü–û–õ–ù–ï–ù–û
- **–°—Ç–∞—Ç—É—Å**: ‚úÖ –í–´–ü–û–õ–ù–ï–ù–û

---

## üìä –ß–ï–ö–õ–ò–°–¢ –í–´–ü–û–õ–ù–ï–ù–ò–Ø

### ‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–æ (40/50 - 80%)
- [x] –ò—Å–ø—Ä–∞–≤–∏—Ç—å STUCK_LOOP action –≤ rules.yaml
- [x] –ü–µ—Ä–µ–ø–∏—Å–∞—Ç—å loop_detector.py (translation-based)
- [x] –û–±–Ω–æ–≤–∏—Ç—å dialog_analysis/llm.py
- [x] –û–±–Ω–æ–≤–∏—Ç—å dialog_analysis/config.yaml
- [x] –ò–∑–º–µ–Ω–∏—Ç—å state.py reducer
- [x] –î–æ–±–∞–≤–∏—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ translated –≤ archive_session
- [x] –°–æ–∑–¥–∞—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é
- [x] –û–±–Ω–æ–≤–∏—Ç—å pipeline_order.yaml
- [x] –ü–µ—Ä–µ–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å pipeline_config.yaml
- [x] –°–æ–∑–¥–∞—Ç—å app/services/cache/ (–≤—Å–µ –º–æ–¥—É–ª–∏)
- [x] –°–æ–∑–¥–∞—Ç—å app/nodes/check_cache/ (–ø–æ–ª–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞)
- [x] –°–æ–∑–¥–∞—Ç—å app/nodes/store_in_cache/ (–ø–æ–ª–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞)
- [x] –°–æ–∑–¥–∞—Ç—å app/nodes/cache_similarity/ (–ø–æ–ª–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞)
- [x] –û–±–Ω–æ–≤–∏—Ç—å graph.py (–∏–º–ø–æ—Ä—Ç—ã –∏ NODE_FUNCTIONS)
- [x] –î–æ–±–∞–≤–∏—Ç—å cache_similarity –≤ pipeline_order.yaml
- [x] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å session_starter –∑–∞–≥—Ä—É–∑–∫—É metadata
- [x] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ archive_session —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç translated –≤ –ë–î
- [x] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ store_in_cache —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç translated –≤ –∫–µ—à
- [x] –°–æ–∑–¥–∞—Ç—å app/cache/DEPRECATED.md
- [x] –û–±–Ω–æ–≤–∏—Ç—å app/cache/__init__.py (–æ–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å)
- [x] –°–æ–∑–¥–∞—Ç—å scripts/migrate_add_translations.py
- [x] –°–æ–∑–¥–∞—Ç—å scripts/cleanup_deprecated_cache.py
- [x] –ò—Å–ø—Ä–∞–≤–∏—Ç—å Windows event loop compatibility
- [x] –°–æ–∑–¥–∞—Ç—å stub —Ñ–∞–π–ª—ã –¥–ª—è –ø–æ–ª–Ω–æ–π –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
- [x] –û–±–Ω–æ–≤–∏—Ç—å cleanup —Å–∫—Ä–∏–ø—Ç (—Å–æ–∑–¥–∞–Ω–∏–µ stubs –≤–º–µ—Å—Ç–æ —É–¥–∞–ª–µ–Ω–∏—è)
- [x] –°–æ–∑–¥–∞—Ç—å scripts/MIGRATION_GUIDE.md

### ‚è≥ –í –ø—Ä–æ—Ü–µ—Å—Å–µ (0/50)
- –ù–µ—Ç

### üìã TODO (10/50 - 20%)
- [ ] –ó–∞–ø—É—Å—Ç–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ): `python scripts/migrate_add_translations.py`
- [ ] –°–æ–∑–¥–∞—Ç—å unit —Ç–µ—Å—Ç—ã (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
- [ ] –°–æ–∑–¥–∞—Ç—å integration —Ç–µ—Å—Ç—ã (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
- [ ] –û–±–Ω–æ–≤–∏—Ç—å README.md (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
- [ ] –°–æ–∑–¥–∞—Ç—å ARCHITECTURE.md (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

---

## üéØ –ü–†–ò–û–†–ò–¢–ï–¢–´

### P0 - –ö—Ä–∏—Ç–∏—á–Ω–æ (–¥–æ–ª–∂–Ω–æ —Ä–∞–±–æ—Ç–∞—Ç—å —Å–µ–π—á–∞—Å)
1. ‚úÖ –ò—Å–ø—Ä–∞–≤–∏—Ç—å STUCK_LOOP action
2. ‚úÖ –ò—Å–ø—Ä–∞–≤–∏—Ç—å loop detector (translation-based)
3. ‚è≥ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ—Ä—è–¥–æ–∫ –Ω–æ–¥ –≤ pipeline

### P1 - –í—ã—Å–æ–∫–∏–π (–Ω—É–∂–Ω–æ –¥–ª—è production)
4. ‚è≥ –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ cache ‚Üí services
5. ‚è≥ –°–æ–∑–¥–∞—Ç—å –æ—Ç–¥–µ–ª—å–Ω—ã–µ –Ω–æ–¥—ã (check_cache, store_in_cache, cache_similarity)
6. ‚è≥ –û–±–Ω–æ–≤–∏—Ç—å pipeline –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é

### P2 - –°—Ä–µ–¥–Ω–∏–π (—É–ª—É—á—à–µ–Ω–∏—è)
7. ‚è≥ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
8. ‚è≥ –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
9. ‚è≥ –ú–∏–≥—Ä–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

---

## üìà –û–ñ–ò–î–ê–ï–ú–´–ï –†–ï–ó–£–õ–¨–¢–ê–¢–´

### –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
- ‚úÖ Loop detection: < 100ms (—Å –∫–µ—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–º–∏ –ø–µ—Ä–µ–≤–æ–¥–∞–º–∏)
- ‚úÖ Cache similarity: < 150ms
- ‚úÖ –†–∞–∑–º–µ—Ä state: -30%

### –ö–∞—á–µ—Å—Ç–≤–æ
- ‚úÖ –ù–µ—Ç –ª–æ–∂–Ω—ã—Ö —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏–π loop detector
- ‚úÖ –¢–æ—á–Ω–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ä–µ–∞–ª—å–Ω—ã—Ö –ø–µ—Ç–µ–ª—å
- ‚úÖ –ì–∏–±–∫–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è cache (–º–æ–∂–Ω–æ –æ—Ç–∫–ª—é—á–∏—Ç—å similarity)

### –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞
- ‚úÖ –ß–∏—Å—Ç–æ–µ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ: services (–ª–æ–≥–∏–∫–∞) + nodes (–æ–±–µ—Ä—Ç–∫–∏)
- ‚úÖ –í—Å–µ –Ω–æ–¥—ã —Å–ª–µ–¥—É—é—Ç –ø–∞—Ç—Ç–µ—Ä–Ω—É app/nodes/*/
- ‚úÖ –ú–æ–¥—É–ª—å–Ω–æ—Å—Ç—å –∏ —Ç–µ—Å—Ç–∏—Ä—É–µ–º–æ—Å—Ç—å

---

## üöÄ –°–õ–ï–î–£–Æ–©–ò–ï –®–ê–ì–ò

1. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–µ–∫—É—â–∏–π –ø–æ—Ä—è–¥–æ–∫ –Ω–æ–¥** –≤ pipeline_config.yaml
2. **–ù–∞—á–∞—Ç—å –§–ê–ó–£ 5**: –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ cache ‚Üí services
3. **–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–µ –Ω–æ–¥—ã**: check_cache, store_in_cache, cache_similarity
4. **–û–±–Ω–æ–≤–∏—Ç—å pipeline –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é**
5. **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ**

---

## üìÖ –î–ê–¢–ê –°–û–ó–î–ê–ù–ò–Ø
2026-01-08

## üë§ –ê–í–¢–û–†
Antigravity AI Assistant
