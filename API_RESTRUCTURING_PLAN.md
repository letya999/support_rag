# План реструктуризации и развития API (External REST API)

Этот документ описывает целевое состояние внешнего REST API для системы Support RAG. API проектируется как универсальный шлюз для интеграции с фронтендом, мобильными приложениями и сторонними системами.

---

## 1. Архитектурные принципы и Стандарты

Для обеспечения надежности, безопасности и удобства использования внедряются следующие стандарты:

### 1.1 Версионирование
*   Все эндпоинты будут иметь префикс `/api/v1`.
*   Это позволит в будущем внедрять ломающие изменения в v2 без нарушения работы существующих клиентов.

### 1.2 Стандартизация ответов
Все ответы API (успешные и ошибочные) следуют единой структуре `Envelope`.

**Успешный ответ:**
```json
{
  "data": { ... },       // Полезная нагрузка
  "meta": {              // Метаданные (опционально)
    "pagination": { ... },
    "trace_id": "abc-123"
  }
}
```

**Ошибочный ответ:**
```json
{
  "error": {
    "code": "VALIDATION_ERROR",
    "message": "Invalid input data",
    "details": [ ... ],   // Детали валидации
    "trace_id": "abc-123"
  }
}
```

### 1.3 Инфраструктурные компоненты (Middleware)
1.  **Request ID**: Генерация уникального `X-Request-ID` для каждого запроса (прокидывается в логи и хедеры ответа).
2.  **Global Exception Handler**: Перехват всех исключений и преобразование их в стандартизированный JSON ошибки.
3.  **Rate Limiter**: Ограничение количества запросов (например, 100 req/min для общего API, строже для тяжелых RAG запросов).
4.  **Security Headers**: Валидация базовых заголовков, защита от простейших атак.
5.  **OpenAPI (Swagger)**: Автоматическая генерация документации.

---

## 2. Спецификация Эндпоинтов

### Группа 1: Генерация и RAG (Chat & Generation)
*Основной интерфейс взаимодействия с LLM.*

| Метод | Путь | Описание | Особенности |
| :--- | :--- | :--- | :--- |
| `POST` | `/chat/completions` | Отправка сообщения и получение полного ответа (синхронно). | Ожидание полной генерации. Универсальный формат. |
| `POST` | `/chat/stream` | Отправка сообщения и получение ответа через SSE (Stream). | Стриминг токенов по мере генерации. |
| `POST` | `/chat/escalate` | Принудительная эскалация диалога на оператора. | Создает событие хендоффа. |
| `POST` | `/chat/sessions/{session_id}/escalate` | Эскалация конкретной сессии. | Для админских действий или специфичных флоу. |
| `WS` | `/chat/ws` | WebSocket соединение (Опционально). | Для двустороннего реал-тайм обмена. |

### Группа 2: Управление знаниями (Knowledge Base)
*Загрузка, парсинг и редактирование данных. Использует промежуточное хранилище (Staging/Redis) перед коммитом в основной индекс.*

| Метод | Путь | Описание | Особенности |
| :--- | :--- | :--- | :--- |
| `GET` | `/knowledge/contract` | Получить спецификацию поддерживаемых форматов. | Возвращает правила JSON схемы, лимиты (100 пар, макс. длина вопроса/ответа). |
| `POST` | `/knowledge/upload` | Загрузка файла (JSON, PDF, CSV, MD). | Парсинг и сохранение в **staging (Redis)**. Возврат ID черновика и извлеченных пар. |
| `POST` | `/knowledge/chunks` | Ручное добавление чанков (без файла). | Принимает JSON массив чанков. Сохраняет в **staging**. |
| `PATCH` | `/knowledge/chunks` | Массовое изменение/валидация чанков в черновике. | Используется для ручной правки после парсинга. |
| `DELETE` | `/knowledge/chunks/{chunk_id}` | Удаление конкретного чанка из черновика. | |
| `DELETE` | `/knowledge/files/{file_id}` | Удаление файла и связанных черновых данных. | Очистка staging области. |
| `POST` | `/knowledge/commit` | Подтверждение и сохранение данных в основную БД. | Перенос из **staging (Redis)** в **prod (Postgres/Qdrant)**. |

### Группа 3: Анализ и Классификация (Intelligence)
*Инструменты для работы с метаданными документов.*

| Метод | Путь | Описание | Особенности |
| :--- | :--- | :--- | :--- |
| `POST` | `/analysis/classify/{document_id}` | Запуск авто-классификации категорий/интентов. | Берет чанки документы из БД, прогоняет через пайплайн классификации. |
| `POST` | `/analysis/metadata` | Сохранение/Обновление размеченных данных. | Применение результатов классификации в БД. |
| `PATCH` | `/analysis/chunks/metadata` | Точечное изменение метаданных чанков. | Ручная корректировка категории/интента у конкретных пар. |

### Группа 4: Интенты и Категории (Taxonomy)
*Управление справочниками.*

| Метод | Путь | Описание | Особенности |
| :--- | :--- | :--- | :--- |
| `GET` | `/taxonomy/tree` | Получить дерево Категорий и Интентов. | Иерархический справочник. |
| `PATCH` | `/taxonomy/rename` | Переименование категории или интента. | Массовое обновление ссылок в БД. |
| `POST` | `/taxonomy/sync` | Сканирование документов и обновление справочника. | Актуализация справочника на основе текущей базы знаний. |

### Группа 5: История и Сессии (History)
*Работа с долговременной памятью.*

| Метод | Путь | Описание | Особенности |
| :--- | :--- | :--- | :--- |
| `GET` | `/history` | Получить сообщения пользователя. | Фильтры: `user_id`, `role`, `limit` (N последних). |
| `DELETE` | `/history` | Сброс истории диалога. | Hard или Soft delete в БД. |

### Группа 6: Кеш (Cache Debugging)
*Отладка оперативной памяти.*

| Метод | Путь | Описание | Особенности |
| :--- | :--- | :--- | :--- |
| `GET` | `/cache/messages` | Получить N последних сообщений из Redis. | Для отладки контекста. |
| `DELETE` | `/cache` | Очистка кеша. | Параметры: `user_id` (конкретный) или `all`. |
| `GET` | `/cache/status` | Состояние Redis. | Metrics, Memory usage. |

### Группа 7: Конфигурация (Config)

| Метод | Путь | Описание | Особенности |
| :--- | :--- | :--- | :--- |
| `GET` | `/config/full` | Текущая полная конфигурация RAG. | Скрытие секретов (masking). |
| `GET` | `/config/phrases` | Системные фразы и паттерны. | |

### Группа 8: Общее (System)

| Метод | Путь | Описание | Особенности |
| :--- | :--- | :--- | :--- |
| `GET` | `/health` | Проверка здоровья. | DB, Redis, LLM API status. |
| `GET` | `/ping` | Быстрый ответ "pong". | Для балансировщиков. |

### Группа 9: Каналы связи (Channels Integration)
*Прямое управление сообщениями в подключенных каналах (Telegram и др.) в обход RAG пайплайна.*

| Метод | Путь | Описание | Особенности |
| :--- | :--- | :--- | :--- |
| `POST` | `/channels/messages` | Отправка сообщения пользователю от имени бота. | Не вызывает RAG. Сохраняется в истории как сообщение бота. |
| `PATCH` | `/channels/messages/{message_id}` | Редактирование ранее отправленного сообщения. | Изменяет текст в чате (если канал поддерживает). |
| `DELETE` | `/channels/messages/{message_id}` | Удаление сообщения из чата. | Удаляет сообщение у пользователя (если канал поддерживает). |

---

## 3. План реализации

### Этап 1: Фундамент (Infrastructure)
1.  Создать структуру `app/api/v1`.
2.  Реализовать базовые модели (`Envelope`, `ErrorResponse`).
3.  Настроить Middleware (Exception Handler, Request ID).
4.  Подключить `fastapi-limiter` (Redis based) для Rate Limiting.

### Этап 2: Миграция и Реализация "Chat & Channels"
1.  Переписать `rag_routes.py` в новый контроллер `ChatController`.
2.  Реализовать поддержку SSE (используя `EventSourceResponse` из `sstarlette` или стандартный `StreamingResponse`).
3.  Реализовать контроллер `ChannelController` для прямых сообщений (интеграция с `TelegramBot` классом для `send/edit/delete`).
4.  Разделить логику: контроллер только валидирует и вызывает Service Layer.

### Этап 3: Управление Знаниями (Knowledge)
1.  Создать таблицы/модели для "Черновиков" (Drafts), чтобы не писать сразу в боевой индекс.
2.  Реализовать валидаторы форматов (JSON Schema validation).
3.  Реализовать эндпоинты загрузки и редактирования.

### Этап 4: Таксономия и Анализ
1.  Выделить справочник Интентов/Категорий в отдельную сущность БД (сейчас это часто часть конфига или самих чанков).
2.  Реализовать логику синхронизации справочника.

### Этап 5: Ops & Cleanup
1.  Добавить Swagger теги и описания.
2.  Удалить старые роуты (`app/api/rag_routes.py` и др) после переключения клиентов.
