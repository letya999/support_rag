# –ú–∞—Ç—Ä–∏—Ü–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π —É–∑–ª–æ–≤ RAG Pipeline

## –õ–µ–≥–µ–Ω–¥–∞

| –°–∏–º–≤–æ–ª | –ó–Ω–∞—á–µ–Ω–∏–µ |
|--------|---------|
| ‚û°Ô∏è | –ü—Ä—è–º–∞—è –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å (–¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –¥–æ) |
| ‚Ü©Ô∏è | –û–±—Ä–∞—Ç–Ω–∞—è –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å (–º–æ–∂–µ—Ç –±—ã—Ç—å –ø–æ—Å–ª–µ) |
| ‚ö° | –ñ–µ—Å—Ç–∫–∞—è –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å |
| ‚ö†Ô∏è | –£—Å–ª–æ–≤–Ω–∞—è –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å |
| ‚úì | –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–∞—è/–Ω–µ–∑–∞–≤–∏—Å–∏–º–∞—è |
| ‚ùå | –ö–æ–Ω—Ñ–ª–∏–∫—Ç |

---

## –¢–∞–±–ª–∏—Ü–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π

### –ì—Ä—É–ø–ø–∞ 1: –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –∏ —Å–µ—Å—Å–∏—è (–ö–†–ò–¢–ò–ß–ù–û –£–ü–û–†–Ø–î–û–ß–ï–ù–û)

| –£–∑–µ–ª | –¢—Ä–µ–±—É–µ—Ç | –ò—Å–ø–æ–ª—å–∑—É–µ—Ç | –ú–æ–∂–µ—Ç –±–µ–∑ | –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ |
|------|---------|-----------|-----------|-----------|
| `session_starter` | START | user_id, session_id | conversation_history | ‚úì –ü–µ—Ä–≤—ã–π —É–∑–µ–ª |
| `input_guardrails` ‚ö° | session_starter | question | ‚Äî | üîê –ü–ï–†–ï–î check_cache |
| `check_cache` ‚ö° | input_guardrails | question | ‚Äî | üîê –ü–û–°–õ–ï guardrails |

**–í—ã–≤–æ–¥:** –ü–æ—Ä—è–¥–æ–∫ –∂–µ—Å—Ç–∫–æ –∑–∞–∫—Ä–µ–ø–ª–µ–Ω –ø–æ –ø—Ä–∏—á–∏–Ω–µ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏.

---

### –ì—Ä—É–ø–ø–∞ 2: –û–±—Ä–∞–±–æ—Ç–∫–∞ —è–∑—ã–∫–∞ –∏ –∞–Ω–∞–ª–∏–∑ –¥–∏–∞–ª–æ–≥–∞ (–ß–ê–°–¢–ò–ß–ù–û –ì–ò–ë–ö–ò–ï)

| –£–∑–µ–ª | –¢—Ä–µ–±—É–µ—Ç | –ò—Å–ø–æ–ª—å–∑—É–µ—Ç | –ú–æ–∂–µ—Ç –±–µ–∑ | –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ |
|------|---------|-----------|-----------|-----------|
| `language_detection` | ‚úì –ú–æ–∂–µ—Ç –±—ã—Ç—å –≤ –ª—é–±–æ–π –º–æ–º–µ–Ω—Ç | question | –î–∞ (fallback: 'ru') | ‚úÖ –ü–æ–ª–Ω–æ—Å—Ç—å—é –Ω–µ–∑–∞–≤–∏—Å–∏–º |
| `dialog_analysis` ‚ö†Ô∏è | check_cache | conversation_history, question | question | ‚ö†Ô∏è –ë—ã—Å—Ç—Ä–∞—è —ç—Å–∫–∞–ª–∞—Ü–∏—è –≤–æ–∑–º–æ–∂–Ω–∞ |
| `aggregation` | dialog_analysis | question, conversation_history | –î–∞ (question as-is) | ‚úì –ë–µ–∑–æ–ø–∞—Å–µ–Ω –≤–µ–∑–¥–µ |

**–í—ã–≤–æ–¥:** `language_detection` –º–æ–∂–µ—Ç –±—ã—Ç—å –≤ –Ω–∞—á–∞–ª–µ/–∫–æ–Ω—Ü–µ. `dialog_analysis` –Ω—É–∂–Ω–∞ –∏—Å—Ç–æ—Ä–∏—è.

---

### –ì—Ä—É–ø–ø–∞ 3: –ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è (–ì–ò–ë–ö–ò–ï)

| –£–∑–µ–ª | –¢—Ä–µ–±—É–µ—Ç | –ò—Å–ø–æ–ª—å–∑—É–µ—Ç | –ú–æ–∂–µ—Ç –±–µ–∑ | –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ |
|------|---------|-----------|-----------|-----------|
| `easy_classification` | ‚úì –ú–æ–∂–µ—Ç –±—ã—Ç—å –¥–æ/–ø–æ—Å–ª–µ aggregation | translated_query –∏–ª–∏ question | –î–∞ (fallback) | ‚úÖ –ú–æ–∂–µ—Ç –±—ã—Ç—å –î–û aggregation |
| `classify` | ‚úì –ú–æ–∂–µ—Ç –±—ã—Ç—å —Å easy_classification | question | –î–∞ (optional) | ‚úÖ –ú–æ–∂–µ—Ç –±—ã—Ç—å –ø–∞—Ä–∞–ª–ª–µ–ª—å |
| `query_translation` | language_detection | question, detected_language | –î–∞ (no-op) | ‚úì –ë–µ–∑–æ–ø–∞—Å–Ω–∞ –≤–µ–∑–¥–µ |

**–í—ã–≤–æ–¥:** –ü–æ—Ä—è–¥–æ–∫ –º–æ–∂–µ—Ç –±—ã—Ç—å –≥–∏–±–∫–∏–º. –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è: classification ‚Üí metadata_filtering.

---

### –ì—Ä—É–ø–ø–∞ 4: –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö (–£–°–õ–û–í–ù–û –ì–ò–ë–ö–ò–ï)

| –£–∑–µ–ª | –¢—Ä–µ–±—É–µ—Ç | –ò—Å–ø–æ–ª—å–∑—É–µ—Ç | –ú–æ–∂–µ—Ç –±–µ–∑ | –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ |
|------|---------|-----------|-----------|-----------|
| `metadata_filtering` ‚ö†Ô∏è | easy_classification | semantic_category | –î–∞ (filter_used=False) | ‚ö†Ô∏è –¢–†–ï–ë–£–ï–¢ easy_classification |
| `expand_query` | ‚úì –ú–æ–∂–µ—Ç –±—ã—Ç—å –≥–∏–±–∫–æ | question | –î–∞ (empty queries) | ‚úì –ú–æ–∂–µ—Ç –±—ã—Ç—å —Å –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–µ–π |

**–í—ã–≤–æ–¥:** `metadata_filtering` —Ç—Ä–µ–±—É–µ—Ç `easy_classification`. `expand_query` –ø–æ–ª–Ω–æ—Å—Ç—å—é –Ω–µ–∑–∞–≤–∏—Å–∏–º.

---

### –ì—Ä—É–ø–ø–∞ 5: –ü–æ–∏—Å–∫ (–ñ–ï–°–¢–ö–ò–ï –í–ó–ê–ò–ú–û–û–¢–ù–û–®–ï–ù–ò–Ø)

#### 5.1 –í–∞—Ä–∏–∞–Ω—Ç –ê: –ì–∏–±—Ä–∏–¥–Ω—ã–π –ø–æ–∏—Å–∫
| –£–∑–µ–ª | –¢—Ä–µ–±—É–µ—Ç | –ò—Å–ø–æ–ª—å–∑—É–µ—Ç | –ú–æ–∂–µ—Ç –±–µ–∑ | –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ |
|------|---------|-----------|-----------|-----------|
| `hybrid_search` ‚ö° | metadata_filtering | translated_query, matched_category, detected_language | –î–∞ (fallback) | ‚úÖ –í—Å–µ –æ–ø—Ü–∏–∏ –µ—Å—Ç—å |
| `reranking` ‚ö° | hybrid_search | question, docs | –î–∞ (return docs as-is) | ‚ö†Ô∏è –¢–†–ï–ë–£–ï–¢ docs |

#### 5.2 –í–∞—Ä–∏–∞–Ω—Ç B: –†–∞–∑–¥–µ–ª–µ–Ω–Ω—ã–π –ø–æ–∏—Å–∫
| –£–∑–µ–ª | –¢—Ä–µ–±—É–µ—Ç | –ò—Å–ø–æ–ª—å–∑—É–µ—Ç | –ú–æ–∂–µ—Ç –±–µ–∑ | –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ |
|------|---------|-----------|-----------|-----------|
| `retrieve` ‚úì | expand_query | aggregated_query –∏–ª–∏ question | –î–∞ | ‚úÖ –ù–µ–∑–∞–≤–∏—Å–∏–º |
| `lexical_search` ‚úì | retrieve | question | –î–∞ | ‚úÖ –ù–µ–∑–∞–≤–∏—Å–∏–º |
| `fusion` ‚ùå | retrieve + lexical | vector_results, lexical_results | –ù–ï–¢ | ‚ö†Ô∏è **–¢–†–ï–ë–£–ï–¢ –û–ë–ê** |

**–í—ã–≤–æ–¥:**
- ‚úÖ –ï—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `hybrid_search` - –≤—Å–µ —Ö–æ—Ä–æ—à–æ
- ‚ö†Ô∏è –ï—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `retrieve + lexical_search`, —Ç–æ `fusion` –¢–†–ï–ë–£–ï–¢ –æ–±–∞ –≤—Ö–æ–¥–∞
- üî¥ –ï—Å–ª–∏ –∑–∞–ø—É—â–µ–Ω–∞ —Ç–æ–ª—å–∫–æ –æ–¥–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è –ø–æ–∏—Å–∫–∞, `fusion` –≤–µ—Ä–Ω–µ—Ç –ø—É—Å—Ç–æ–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç

---

### –ì—Ä—É–ø–ø–∞ 6: –ü–µ—Ä–µ—Ä–∞–Ω–∂–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ —É–º–Ω—ã–µ –≤—ã–≤–æ–¥—ã (–ñ–ï–°–¢–ö–ò–ï)

| –£–∑–µ–ª | –¢—Ä–µ–±—É–µ—Ç | –ò—Å–ø–æ–ª—å–∑—É–µ—Ç | –ú–æ–∂–µ—Ç –±–µ–∑ | –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ |
|------|---------|-----------|-----------|-----------|
| `reranking` ‚ö° | –ø–æ–∏—Å–∫ (–ª—é–±–æ–π) | question, docs | –î–∞ (pass-through) | ‚úÖ –ú–æ–∂–µ—Ç –±—ã—Ç—å –ø—Ä–æ–ø—É—â–µ–Ω |
| `multihop` ‚ö†Ô∏è | reranking | question, docs, confidence, rerank_scores | –î–∞ (–Ω–æ —Ç–µ—Ä—è–µ—Ç—Å—è –∫–∞—á–µ—Å—Ç–≤–æ) | ‚ö†Ô∏è –ò—Å–ø–æ–ª—å–∑—É–µ—Ç confidence |

**–í—ã–≤–æ–¥:** `multihop` –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—Ä–æ–ø—É—â–µ–Ω –ø—Ä–∏ –≤—ã—Å–æ–∫–æ–π —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏ (skip_if_high_confidence=True).

---

### –ì—Ä—É–ø–ø–∞ 7: –†–µ—à–µ–Ω–∏–µ –∏ –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è (–ñ–ï–°–¢–ö–ò–ï)

| –£–∑–µ–ª | –¢—Ä–µ–±—É–µ—Ç | –ò—Å–ø–æ–ª—å–∑—É–µ—Ç | –ú–æ–∂–µ—Ç –±–µ–∑ | –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ |
|------|---------|-----------|-----------|-----------|
| `state_machine` ‚ö° | multihop | dialog_analysis, docs, confidence | –î–∞ (fallback logic) | ‚ö†Ô∏è –ù—É–∂–Ω–∞ confidence |
| `routing` ‚ö° | state_machine | action_recommendation | –î–∞ (fallback) | üîê –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç generation |
| `prompt_routing` ‚úì | routing | state | –î–∞ (default prompt) | ‚úÖ –ú–æ–∂–µ—Ç –±—ã—Ç—å –ø—Ä–æ–ø—É—â–µ–Ω |

**–í—ã–≤–æ–¥:**
- `state_machine` ‚Üí `routing` - **–∂–µ—Å—Ç–∫–∞—è —Å–≤—è–∑—å**
- `routing` –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç, –∏–¥—Ç–∏ –ª–∏ –≤ `generation`

---

### –ì—Ä—É–ø–ø–∞ 8: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è (–°–õ–ê–ë–û –°–í–Ø–ó–ê–ù–´)

| –£–∑–µ–ª | –¢—Ä–µ–±—É–µ—Ç | –ò—Å–ø–æ–ª—å–∑—É–µ—Ç | –ú–æ–∂–µ—Ç –±–µ–∑ | –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ |
|------|---------|-----------|-----------|-----------|
| `generation` ‚úì | routing | question, docs, system_prompt | question (hallucinate) | ‚úÖ –ú–æ–∂–µ—Ç –±—ã—Ç—å –±–µ–∑ docs |
| `output_guardrails` ‚úì | generation | answer | –Ø (pass-through) | ‚úì –ú–æ–∂–µ—Ç –±—ã—Ç—å –≥–¥–µ —É–≥–æ–¥–Ω–æ |

**–í—ã–≤–æ–¥:** –û–±–∞ —É–∑–ª–∞ –Ω–µ–∑–∞–≤–∏—Å–∏–º—ã. –ü–æ—Ä—è–¥–æ–∫ –Ω–µ–≤–∞–∂–µ–Ω.

---

### –ì—Ä—É–ø–ø–∞ 9: –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ (–ù–ï–ó–ê–í–ò–°–ò–ú–´)

| –£–∑–µ–ª | –¢—Ä–µ–±—É–µ—Ç | –ò—Å–ø–æ–ª—å–∑—É–µ—Ç | –ú–æ–∂–µ—Ç –±–µ–∑ | –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ |
|------|---------|-----------|-----------|-----------|
| `archive_session` ‚úì | generation | answer, dialog_state | –î–∞ (no-op) | ‚úì –ú–æ–∂–µ—Ç –±—ã—Ç—å –≥–¥–µ —É–≥–æ–¥–Ω–æ |
| `store_in_cache` ‚úì | archive_session –∏–ª–∏ generation | answer | –î–∞ (no-op) | ‚úì –ú–æ–∂–µ—Ç –±—ã—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–º |

**–í—ã–≤–æ–¥:** –û–±–∞ —É–∑–ª–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é –Ω–µ–∑–∞–≤–∏—Å–∏–º—ã. –ü–æ—Ä—è–¥–æ–∫ –Ω–µ–≤–∞–∂–µ–Ω.

---

## –ú–∞—Ç—Ä–∏—Ü–∞ —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ (Compatibility Matrix)

```
                  ‚Üì –¢–†–ï–ë–£–ï–¢ –í–´–®–ï
      LS  RET  HS  RR  MH  SM  RT  GEN
   LS  ‚úì   ‚Ü©Ô∏è   ‚ùå  ‚Ü©Ô∏è   ‚Ü©Ô∏è   ‚Ü©Ô∏è   ‚Ü©Ô∏è   ‚Ü©Ô∏è
   RET ‚Ü©Ô∏è   ‚úì   ‚Ü©Ô∏è  ‚Ü©Ô∏è   ‚Ü©Ô∏è   ‚Ü©Ô∏è   ‚Ü©Ô∏è   ‚Ü©Ô∏è
   HS  ‚ùå  ‚Ü©Ô∏è   ‚úì   ‚Ü©Ô∏è   ‚Ü©Ô∏è   ‚Ü©Ô∏è   ‚Ü©Ô∏è   ‚Ü©Ô∏è
   RR  ‚Ü©Ô∏è  ‚Ü©Ô∏è   ‚Ü©Ô∏è   ‚úì   ‚Ü©Ô∏è   ‚Ü©Ô∏è   ‚Ü©Ô∏è   ‚Ü©Ô∏è
   MH  ‚Ü©Ô∏è  ‚Ü©Ô∏è   ‚Ü©Ô∏è   ‚Ü©Ô∏è   ‚úì   ‚Ü©Ô∏è   ‚Ü©Ô∏è   ‚Ü©Ô∏è
   SM  ‚Ü©Ô∏è  ‚Ü©Ô∏è   ‚Ü©Ô∏è   ‚Ü©Ô∏è   ‚Ü©Ô∏è   ‚úì   ‚ö°   ‚Ü©Ô∏è
   RT  ‚Ü©Ô∏è  ‚Ü©Ô∏è   ‚Ü©Ô∏è   ‚Ü©Ô∏è   ‚Ü©Ô∏è   ‚ö°   ‚úì   ‚ö°
   GEN ‚Ü©Ô∏è  ‚Ü©Ô∏è   ‚Ü©Ô∏è   ‚Ü©Ô∏è   ‚Ü©Ô∏è   ‚Ü©Ô∏è   ‚ö°   ‚úì

–õ–µ–≥–µ–Ω–¥–∞:
‚úì  = –°–æ–≤–º–µ—Å—Ç–∏–º—ã –∏ –Ω–µ–∑–∞–≤–∏—Å–∏–º—ã
‚Ü©Ô∏è  = –ú–æ–∂–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å (–µ—Å—Ç—å fallback)
‚ö° = –ñ–µ—Å—Ç–∫–∞—è —Å–≤—è–∑—å
‚ùå = –ö–æ–Ω—Ñ–ª–∏–∫—Ç (fusion —Ç—Ä–µ–±—É–µ—Ç –æ–±–µ —Ñ—É–Ω–∫—Ü–∏–∏ –ø–æ–∏—Å–∫–∞)
```

---

## –ê–Ω–∞–ª–∏–∑ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –ø—É—Ç–µ–π

### –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π –ø—É—Ç—å 1: –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å
```
START ‚Üí session_starter ‚Üí input_guardrails ‚Üí check_cache ‚Üí ...
        ‚úÖ –û–ë–Ø–ó–ê–¢–ï–õ–ï–ù –ü–û–†–Ø–î–û–ö
        üîê –ù–µ–ª—å–∑—è –º–µ–Ω—è—Ç—å
```

### –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π –ø—É—Ç—å 2: –ü–æ–∏—Å–∫ (–í–∞—Ä–∏–∞–Ω—Ç A)
```
... ‚Üí metadata_filtering ‚Üí expand_query ‚Üí hybrid_search ‚Üí reranking ‚Üí ...
      ‚úÖ –†–ï–ö–û–ú–ï–ù–î–£–ï–ú–´–ô –ü–û–†–Ø–î–û–ö
      ‚ö†Ô∏è –ú–æ–∂–µ—Ç –±—ã—Ç—å –≥–∏–±–∫–∏–º, –Ω–æ —ç—Ç–æ –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ
```

### –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π –ø—É—Ç—å 3: –ü–æ–∏—Å–∫ (–í–∞—Ä–∏–∞–Ω—Ç B) - –û–ü–ê–°–ù–û
```
... ‚Üí retrieve + lexical_search (–ø–∞—Ä–∞–ª–ª–µ–ª—å) ‚Üí fusion ‚Üí reranking ‚Üí ...
      ‚ö†Ô∏è –¢–†–ï–ë–£–ï–¢ –û–ë–ê –í–•–û–î–ê –í FUSION
      ‚ùå –ï—Å–ª–∏ –∑–∞–ø—É—â–µ–Ω–∞ —Ç–æ–ª—å–∫–æ –æ–¥–Ω–∞, fusion –≤–µ—Ä–Ω–µ—Ç –ø—É—Å—Ç–æ–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç
```

### –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π –ø—É—Ç—å 4: –†–µ—à–µ–Ω–∏–µ
```
... ‚Üí state_machine ‚Üí routing ‚Üí (generation | END)
      ‚ö° –ñ–ï–°–¢–ö–ò–ô –ü–û–†–Ø–î–û–ö
      üîê routing –∑–∞–≤–∏—Å–∏—Ç –æ—Ç action_recommendation
```

---

## –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –ø–µ—Ä–µ—É–ø–æ—Ä—è–¥–æ—á–µ–Ω–∏—é

### ‚úÖ –ë–ï–ó–û–ü–ê–°–ù–û –ü–ï–†–ï–£–ü–û–†–Ø–î–û–ß–ò–¢–¨

```yaml
# –í–∞—Ä–∏–∞–Ω—Ç 1: –ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è —Ä–∞–Ω—å—à–µ
session_starter
  ‚Üì
input_guardrails
  ‚Üì
check_cache
  ‚Üì
language_detection
  ‚Üì
easy_classification    # ‚Üê –†–ê–ù–¨–®–ï aggregation
  ‚Üì
metadata_filtering
  ‚Üì
aggregation
  ‚Üì
...

# –í–∞—Ä–∏–∞–Ω—Ç 2: –ü–æ–∏—Å–∫ —Å —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ–º –∑–∞–ø—Ä–æ—Å–∞
metadata_filtering
  ‚Üì
expand_query           # ‚Üê –î–û –ø–æ–∏—Å–∫–∞ (—ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–µ–µ)
  ‚Üì
hybrid_search
  ‚Üì
reranking
  ‚Üì
...
```

### üö´ –ù–ï–õ–¨–ó–Ø –ü–ï–†–ï–£–ü–û–†–Ø–î–û–ß–ò–¢–¨

```yaml
# ‚ùå –û–ü–ê–°–ù–û: Guardrails –ø–æ—Å–ª–µ –∫–µ—à–∞
check_cache      # ‚Üê –ú–æ–∂–µ—Ç –≤–µ—Ä–Ω—É—Ç—å –º–∞–ª–∏—Ü–∏–π –∫–æ–Ω—Ç–µ–Ω—Ç
  ‚Üì
input_guardrails # ‚Üê –°–ª–∏—à–∫–æ–º –ø–æ–∑–¥–Ω–æ

# ‚ùå –û–ü–ê–°–ù–û: Fusion –±–µ–∑ –æ–±–µ–∏—Ö —Ñ—É–Ω–∫—Ü–∏–π –ø–æ–∏—Å–∫–∞
retrieve         # ‚Üê –¢–æ–ª—å–∫–æ –æ–¥–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è –ø–æ–∏—Å–∫–∞
  ‚Üì
fusion           # ‚Üê –ù–µ—Ç lexical_results!

# ‚ùå –û–ü–ê–°–ù–û: Routing –¥–æ state_machine
state_machine
  ‚Üì
routing          # –¢–†–ï–ë–£–ï–¢ action_recommendation
```

---

## –¢–∞–±–ª–∏—Ü–∞ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã—Ö –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö —É–∑–ª–æ–≤

–≠—Ç–∏ —É–∑–ª—ã –º–æ–≥—É—Ç –±—ã—Ç—å –∑–∞–ø—É—â–µ–Ω—ã –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ, —Ç.–∫. –Ω–µ –∑–∞–≤–∏—Å—è—Ç –¥—Ä—É–≥ –æ—Ç –¥—Ä—É–≥–∞:

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ         –ü–ê–†–ê–õ–õ–ï–õ–¨–ù–ê–Ø –ì–†–£–ü–ü–ê 1           ‚îÇ
‚îÇ language_detection                      ‚îÇ
‚îÇ easy_classification                     ‚îÇ
‚îÇ dialog_analysis                         ‚îÇ
‚îÇ aggregation (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –ù–ï LLM mode)   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
        ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ         –ü–ê–†–ê–õ–õ–ï–õ–¨–ù–ê–Ø –ì–†–£–ü–ü–ê 2           ‚îÇ
‚îÇ query_translation                       ‚îÇ
‚îÇ expand_query                            ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
        ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ         –ü–ê–†–ê–õ–õ–ï–õ–¨–ù–ê–Ø –ì–†–£–ü–ü–ê 3           ‚îÇ
‚îÇ retrieve (vector search)        ‚îê       ‚îÇ
‚îÇ lexical_search (BM25 search)    ‚îú‚îÄ‚Üí fusion
‚îÇ hybrid_search (–µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è)      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
        ‚Üì
       reranking
        ‚Üì
       multihop
```

**–ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–æ–µ —É—Å–∫–æ—Ä–µ–Ω–∏–µ:** –î–æ 3x –ø—Ä–∏ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –≥—Ä—É–ø–ø—ã 1.

---

## –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø—Ä–æ–±–ª–µ–º

### –ï—Å–ª–∏ `docs` –ø—É—Å—Ç–∞

| –°—Ü–µ–Ω–∞—Ä–∏–π | –í–µ—Ä–æ—è—Ç–Ω–∞—è –ø—Ä–∏—á–∏–Ω–∞ | –ü—Ä–æ–≤–µ—Ä–∏—Ç—å |
|----------|------------------|-----------|
| –ü–æ—Å–ª–µ `retrieve` | –ò–Ω–¥–µ–∫—Å –ø—É—Å—Ç –∏–ª–∏ –∑–∞–ø—Ä–æ—Å –Ω–µ –Ω–∞–π–¥–µ–Ω | –í–µ–∫—Ç–æ—Ä –ë–î |
| –ü–æ—Å–ª–µ `lexical_search` | BM25 –Ω–µ –Ω–∞—à–µ–ª –¥–æ–∫—É–º–µ–Ω—Ç—ã | Lexical –∏–Ω–¥–µ–∫—Å |
| –ü–æ—Å–ª–µ `fusion` | –û–±–µ —Ñ—É–Ω–∫—Ü–∏–∏ –ø–æ–∏—Å–∫–∞ –≤–µ—Ä–Ω—É–ª–∏ –ø—É—Å—Ç–æ | retrieve –ò lexical |
| –ü–æ—Å–ª–µ `reranking` | docs –±—ã–ª–∞ –ø—É—Å—Ç–∞ –î–û reranking | –£–∑–µ–ª –ø–µ—Ä–µ–¥ reranking |

### –ï—Å–ª–∏ `confidence` –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è

| –£–∑–µ–ª | –í—ã—Ö–æ–¥ `confidence` | –ü—Ä–æ–≤–µ—Ä–∏—Ç—å |
|------|------------------|-----------|
| `retrieve` | –ò–∑ scores[0] –≤–µ–∫—Ç–æ—Ä–∞ | –ú–æ–¥–µ–ª—å embeddings |
| `reranking` | –ò–∑ rerank_scores[0] | –ú–æ–¥–µ–ª—å reranker |
| `hybrid_search` | –ò–∑ –≥–∏–±—Ä–∏–¥–Ω–æ–≥–æ RRF | –û–±–∞ –∏–Ω–¥–µ–∫—Å–∞ |
| `fusion` | –ò–∑ fused scores | vector_results + lexical_results |

---

## –í—ã–≤–æ–¥—ã

### –£—Ä–æ–≤–µ–Ω—å –≥–∏–±–∫–æ—Å—Ç–∏ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã

| –ö–∞—Ç–µ–≥–æ—Ä–∏—è | –ì–∏–±–∫–æ—Å—Ç—å | –ü—Ä–∏–º–µ—Ä—ã |
|-----------|----------|--------|
| üî¥ –ñ–µ—Å—Ç–∫–∏–µ (–Ω–µ –º–µ–Ω—è—Ç—å) | 0% | guardrails-cache, state_machine-routing |
| üü° –£—Å–ª–æ–≤–Ω—ã–µ (–ø—Ä–æ–≤–µ—Ä–∏—Ç—å) | 50% | fusion (—Ç—Ä–µ–±—É–µ—Ç –æ–±–µ —Ñ—É–Ω–∫—Ü–∏–∏), metadata_filtering |
| üü¢ –ì–∏–±–∫–∏–µ (—Å–≤–æ–±–æ–¥–∞) | 100% | language_detection, output_guardrails, archive_session |

### –û–±—â–∞—è –æ—Ü–µ–Ω–∫–∞ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã

‚úÖ **–•–æ—Ä–æ—à–æ:**
- –°–ª–∞–±–∞—è —Å–≤—è–∑–∞–Ω–Ω–æ—Å—Ç—å –º–µ–∂–¥—É –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–æ–º —É–∑–ª–æ–≤
- –•–æ—Ä–æ—à–∏–π –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ State –¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏ –¥–∞–Ω–Ω—ã—Ö
- Fallbacks –¥–ª—è –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã—Ö –ø–æ–ª–µ–π
- –ö–æ–Ω—Ñ–∏–≥—É—Ä–∏—Ä—É–µ–º–æ—Å—Ç—å —É–∑–ª–æ–≤

‚ö†Ô∏è **–¢—Ä–µ–±—É–µ—Ç –≤–Ω–∏–º–∞–Ω–∏—è:**
- –ñ–µ—Å—Ç–∫–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –≤ –ø–æ–∏—Å–∫–µ (fusion —Ç—Ä–µ–±—É–µ—Ç –æ–±–µ —Ñ—É–Ω–∫—Ü–∏–∏)
- –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∏ –ø–æ–ª—è `docs`
- –ù–µ—è—Å–Ω–∞—è –ø—Ä–∏–æ—Ä–∏—Ç–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∫–æ–Ω–∫—É—Ä–∏—Ä—É—é—â–∏—Ö –ø–æ–∏—Å–∫–∞—Ö

üöÄ **–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:**
- –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏ –∏ –∞–Ω–∞–ª–∏–∑–∞
- –£—Å–ª–æ–≤–Ω–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ multihop –ø—Ä–∏ –≤—ã—Å–æ–∫–æ–π —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏
- –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø–æ–∏—Å–∫–∞

