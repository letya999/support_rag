# üöÄ Roadmap: –ú–Ω–æ–≥–æ—Ö–æ–¥–æ–≤—ã–µ —Ä–∞—Å—Å—É–∂–¥–µ–Ω–∏—è + –ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ + Telegram –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è

**–ö–æ–º–ø–ª–µ–∫—Å–Ω—ã–π –ø–ª–∞–Ω —Ä–∞–∑–≤–∏—Ç–∏—è Support RAG —Å –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ–º Multi-Hop —Ä–∞—Å—Å—É–∂–¥–µ–Ω–∏–π, –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è –∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å Telegram.**

---

## üìã –û–±–∑–æ—Ä –∏–Ω–∏—Ü–∏–∞—Ç–∏–≤—ã

–¢–µ–∫—É—â–∏–π –ø—Ä–æ–µ–∫—Ç (–≠—Ç–∞–ø 4.7): –î–æ–±–∞–≤–∏—Ç—å –∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–º—É RAG –ø–∞–π–ø–ª–∞–π–Ω—É:
1. **Multi-Hop —Ä–∞—Å—Å—É–∂–¥–µ–Ω–∏—è** ‚Äî –ø–æ–∏—Å–∫ —Ü–µ–ø–æ—á–µ–∫ —Å–≤—è–∑–∞–Ω–Ω—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –¥–ª—è —Å–ª–æ–∂–Ω—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤
2. **–ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ —á–∞—Å—Ç–æ –∑–∞–¥–∞–≤–∞–µ–º—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤** ‚Äî –±—ã—Å—Ç—Ä—ã–µ –æ—Ç–≤–µ—Ç—ã –±–µ–∑ –ø–µ—Ä–µ–æ–±—Ä–∞–±–æ—Ç–∫–∏
3. **Telegram-–∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è** ‚Äî –¥–∏–∞–ª–æ–≥–æ–≤—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
4. **–î–∏–∞–ª–æ–≥–æ–≤–∞—è –ª–æ–≥–∏–∫–∞** ‚Äî —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–µ–π, –∫–æ–º–∞–Ω–¥–∞ `/clear` –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞

**–û–±—â–µ–µ –≤—Ä–µ–º—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏:** 10-14 –¥–Ω–µ–π

---

## üéØ –≠–¢–ê–ü 1: –ú–Ω–æ–≥–æ—Ö–æ–¥–æ–≤—ã–µ —Ä–∞—Å—Å—É–∂–¥–µ–Ω–∏—è (Multi-Hop) ‚Äî 5-6 –¥–Ω–µ–π

### 1.1 –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ Multi-Hop

```
–í–æ–ø—Ä–æ—Å ‚Üí –î–µ—Ç–µ–∫—Ç–æ—Ä —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ ‚Üí
  ‚îú‚îÄ –ï—Å–ª–∏ –ø—Ä–æ—Å—Ç–æ–π ‚Üí –æ–±—ã—á–Ω—ã–π –ø–æ–∏—Å–∫ (retrieve)
  ‚îî‚îÄ –ï—Å–ª–∏ —Å–ª–æ–∂–Ω—ã–π ‚Üí
      ‚îú‚îÄ –ü–µ—Ä–≤—ã–π —Ö–æ–ø: –ø–æ–∏—Å–∫ —Ç–æ–ø-1 —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ–≥–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞
      ‚îú‚îÄ –ì—Ä–∞—Ñ —Å–≤—è–∑–µ–π: –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ see_also/related_topics –∏–∑ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö
      ‚îú‚îÄ –í—Ç–æ—Ä–æ–π+ —Ö–æ–ø—ã: –ø–æ–∏—Å–∫ —Å–≤—è–∑–∞–Ω–Ω—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –ø–æ —Ü–µ–ø–æ—á–∫–µ
      ‚îî‚îÄ –û–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ: —Å–ª–∏—è–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –∏–∑ –≤—Å–µ—Ö —Ö–æ–ø–æ–≤ ‚Üí –≥–µ–Ω–µ—Ä–∞—Ü–∏—è
```

**–ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:**
- **Complexity Detector** ‚Äî –æ—Ü–µ–Ω–∏–≤–∞–µ—Ç —Å–ª–æ–∂–Ω–æ—Å—Ç—å –≤–æ–ø—Ä–æ—Å–∞ (–ø—Ä–æ—Å—Ç–æ–π/—Å—Ä–µ–¥–Ω–∏–π/—Å–ª–æ–∂–Ω—ã–π)
- **Hop Resolver** ‚Äî —É–ø—Ä–∞–≤–ª—è–µ—Ç —Ü–∏–∫–ª–æ–º –ø–æ–∏—Å–∫–∞ –∏ —Å–ª–∏—è–Ω–∏–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
- **Context Merger** ‚Äî –æ–±—ä–µ–¥–∏–Ω—è–µ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç –∏–∑ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —Ö–æ–ø–æ–≤ –≤ –µ–¥–∏–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç
- **Relation Graph** ‚Äî —Å—Ç—Ä–æ–∏—Ç –≥—Ä–∞—Ñ —Å–≤—è–∑–µ–π –º–µ–∂–¥—É –¥–æ–∫—É–º–µ–Ω—Ç–∞–º–∏

---

### 1.2 –î–µ—Ç–µ–∫—Ç–æ—Ä —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ (`app/nodes/multihop/complexity_detector.py`)

**–õ–æ–≥–∏–∫–∞ (–±–µ–∑ LLM –≤—ã–∑–æ–≤–æ–≤, —Ç–æ–ª—å–∫–æ –Ω–∞ –ø—Ä–∞–≤–∏–ª–∞—Ö):**

```python
–ú–µ—Ç—Ä–∏–∫–∏ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏:
1. –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø—Ä–æ—Å–Ω—ã—Ö —Å–ª–æ–≤ (how, what, when, why, which, explain)
   - 0 ‚Üí –ø—Ä–æ—Å—Ç–æ–π (command: "show orders")
   - 1-2 ‚Üí —Å—Ä–µ–¥–Ω–∏–π (question: "how to reset password?")
   - 3+ ‚Üí —Å–ª–æ–∂–Ω—ã–π (reasoning: "why can't I reset password if...")

2. –ù–∞–ª–∏—á–∏–µ —É—Å–ª–æ–≤–Ω—ã—Ö –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏–π (if, after, before, assuming)
   - –ï—Å—Ç—å ‚Üí +1 –∫ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏

3. –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–º–µ–Ω–æ–≤–∞–Ω–Ω—ã—Ö —Å—É—â–Ω–æ—Å—Ç–µ–π (entities)
   - 1 ‚Üí –ø—Ä–æ—Å—Ç–æ–π
   - 2-3 ‚Üí —Å—Ä–µ–¥–Ω–∏–π
   - 4+ ‚Üí —Å–ª–æ–∂–Ω—ã–π

4. –ù–∞–ª–∏—á–∏–µ —Å–ª–æ–≤ "–∏", "–∏–ª–∏", —É–∫–∞–∑—ã–≤–∞—é—â–∏—Ö –Ω–∞ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –∞—Å–ø–µ–∫—Ç—ã
   - –ï—Å—Ç—å –∫–æ–Ω—ä—é–Ω–∫—Ü–∏—è ‚Üí —Å—Ä–µ–¥–Ω–∏–π/—Å–ª–æ–∂–Ω—ã–π

–ò—Ç–æ–≥–æ–≤–∞—è –æ—Ü–µ–Ω–∫–∞:
  sum < 2 ‚Üí simple (retrieval_hops: 1)
  2 <= sum < 4 ‚Üí medium (retrieval_hops: 2)
  sum >= 4 ‚Üí complex (retrieval_hops: 3)
```

**–í—ã—Ö–æ–¥:**
```python
class ComplexityOutput(BaseModel):
    complexity_level: Literal["simple", "medium", "complex"]
    complexity_score: float  # 0-1
    reasoning_keywords: List[str]  # extracted keywords indicating reasoning
    num_hops: int  # —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ–º–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ö–æ–ø–æ–≤
    confidence: float
```

---

### 1.3 Resolver —Ö–æ–ø–æ–≤ (`app/nodes/multihop/hop_resolver.py`)

**–õ–æ–≥–∏–∫–∞:**

```
Hop 0 (–ø–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω—ã–π –ø–æ–∏—Å–∫):
  - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∏—Å—Ö–æ–¥–Ω—ã–π –≤–æ–ø—Ä–æ—Å
  - Retrieval –æ–±—ã—á–Ω—ã–º —Å–ø–æ—Å–æ–±–æ–º ‚Üí top_doc_1
  - –û—Ü–µ–Ω–∫–∞ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç–∏ top_doc_1

Hop 1+ (–¥–ª—è —Å–ª–æ–∂–Ω—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤):
  - –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ —Å–º_also –∏–∑ metadata top_doc_1
  - –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –ø–æ–∏—Å–∫–æ–≤—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –¥–ª—è —Å–≤—è–∑–∞–Ω–Ω—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
  - Retrieval –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Å–≤—è–∑–∞–Ω–Ω–æ–≥–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞
  - –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è (–æ—Å—Ç–∞–≤–∏—Ç—å > threshold —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç–∏)
  - –û–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞

Stop —É—Å–ª–æ–≤–∏—è:
  - –ù–∞–π–¥–µ–Ω "–±–∞–∑–æ–≤—ã–π" –¥–æ–∫—É–º–µ–Ω—Ç (has_complete_answer: true)
  - –í—ã–ø–æ–ª–Ω–µ–Ω—ã –≤—Å–µ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ —Ö–æ–ø—ã
  - –î–æ—Å—Ç–∏–≥–Ω—É—Ç–∞ –≥—Ä–∞–Ω–∏—Ü–∞ –º–∞–∫—Å–∏–º—É–º_—Ö–æ–ø–æ–≤ (–æ–±—ã—á–Ω–æ 3)
```

**–í—ã—Ö–æ–¥:**
```python
class HopResolverOutput(BaseModel):
    primary_doc: str  # —Ç–æ–ø-1 –¥–æ–∫—É–º–µ–Ω—Ç
    related_docs: List[str]  # –¥–æ–∫—É–º–µ–Ω—Ç—ã –∏–∑ —Ö–æ–ø–æ–≤
    hop_chain: List[dict]  # –¥–µ—Ç–∞–ª–∏ –∫–∞–∂–¥–æ–≥–æ —Ö–æ–ø–∞
    merged_context: str  # –æ–±—ä–µ–¥–∏–Ω–µ–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç
    total_hops_performed: int
    retrieval_time: float
    confidence: float  # —Å—Ä–µ–¥–Ω—è—è —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç—å
```

---

### 1.4 –ì—Ä–∞—Ñ —Å–≤—è–∑–µ–π (`app/nodes/multihop/relation_graph.py`)

**–¶–µ–ª—å:** –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–≤—è–∑—è–º–∏ –º–µ–∂–¥—É –¥–æ–∫—É–º–µ–Ω—Ç–∞–º–∏

```python
# –°—Ç—Ä—É–∫—Ç—É—Ä–∞ metadata –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞:
{
  "id": "doc_123",
  "title": "...",
  "category": "...",
  "see_also": ["doc_456", "doc_789"],  # —è–≤–Ω—ã–µ —Å–≤—è–∑–∏
  "keywords": ["password", "reset", "account"],
  "parent_topic": "Account Management",  # –∏–µ—Ä–∞—Ä—Ö–∏—è
  "has_complete_answer": true/false,  # —Å–æ–¥–µ—Ä–∂–∏—Ç –ª–∏ –ø–æ–ª–Ω—ã–π –æ—Ç–≤–µ—Ç
}

# –ì—Ä–∞—Ñ (–≤ –ø–∞–º—è—Ç–∏ –∏–ª–∏ –∫—ç—à):
{
  "doc_123": {
    "direct": ["doc_456", "doc_789"],  # –∏–∑ see_also
    "keyword_based": ["doc_111", "doc_222"],  # –Ω–∞ –æ—Å–Ω–æ–≤–µ –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤
    "category_based": ["doc_333"],  # –≤ —Ç–æ–π –∂–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
  }
}
```

**–§—É–Ω–∫—Ü–∏–∏:**
- `build_relation_graph()` ‚Äî –ø–æ—Å—Ç—Ä–æ–∏—Ç—å –≥—Ä–∞—Ñ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
- `find_related_docs(doc_id)` ‚Äî –Ω–∞–π—Ç–∏ —Å–≤—è–∑–∞–Ω–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã
- `rank_relations(doc_id, query)` ‚Äî —Ä–∞–Ω–∂–∏—Ä–æ–≤–∞—Ç—å —Å–≤—è–∑–∏ –ø–æ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç–∏ –∫ –∑–∞–ø—Ä–æ—Å—É

---

### 1.5 –°–ª–∏—è–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ (`app/nodes/multihop/context_merger.py`)

**–õ–æ–≥–∏–∫–∞ —Å–ª–∏—è–Ω–∏—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –∏–∑ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤:**

```python
–ê–ª–≥–æ—Ä–∏—Ç–º:
1. –£–ø–æ—Ä—è–¥–æ—á–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç—ã –ø–æ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç–∏ (rerank_scores)
2. –û–±—ä–µ–¥–∏–Ω–∏—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç –≤ –ø–æ—Ä—è–¥–∫–µ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç–∏:
   - Primary doc (100%)
   - Hop 1 docs (—Ä–∞–Ω–∂–∏—Ä–æ–≤–∞–Ω—ã)
   - Hop 2+ docs (–µ—Å–ª–∏ –µ—Å—Ç—å –º–µ—Å—Ç–æ –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ)
3. –£–±—Ä–∞—Ç—å –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–Ω—Ç–µ–Ω—Ç–∞
4. –î–æ–±–∞–≤–∏—Ç—å —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª–∏ ### –†–∞–∑–¥–µ–ª N: [–ù–∞–∑–≤–∞–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞]
5. –û–±–µ—Å–ø–µ—á–∏—Ç—å, —á—Ç–æ–±—ã –æ–±—â–∞—è –¥–ª–∏–Ω–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ < max_tokens (5000 tokens)

–°—Ç—Ä–∞—Ç–µ–≥–∏—è –æ–±—Ä–µ–∑–∫–∏ –ø—Ä–∏ –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏–∏:
  - –ï—Å–ª–∏ merged_context > max_tokens:
    - –û–±—Ä–µ–∑–∞—Ç—å –º–µ–Ω–µ–µ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ —Ö–æ–ø—ã
    - –°–æ—Ö—Ä–∞–Ω–∏—Ç—å primary doc (–æ–±—è–∑–∞—Ç–µ–ª–µ–Ω)
```

**–í—ã—Ö–æ–¥:**
```python
class MergedContext(BaseModel):
    combined_text: str
    doc_sources: List[{"doc_id": str, "hop_level": int, "score": float}]
    total_tokens: int
    truncated: bool
```

---

### 1.6 –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ –ø–∞–π–ø–ª–∞–π–Ω

**–†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ –≤ `app/pipeline/state.py`:**

```python
# –î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—è:
complexity_level: Optional[Literal["simple", "medium", "complex"]]
complexity_score: Optional[float]
num_hops_required: Optional[int]

# Multi-hop
primary_doc: Optional[str]
related_docs: List[str]
hop_chain: Optional[List[dict]]
merged_context: Optional[str]
multihop_used: Optional[bool]
hops_performed: Optional[int]
```

**–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ `app/pipeline/graph.py`:**

```
–£—Å–ª–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞ (–ø–æ—Å–ª–µ retrieve, –ø–µ—Ä–µ–¥ generate):
  if complexity_level == "simple":
    ‚Üí –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å multihop ‚Üí generate
  else:
    ‚Üí multihop_resolver ‚Üí generate
```

**Node –≤ graph:**
```
classify ‚Üí metadata_filter ‚Üí retrieve ‚Üí
  [complexity_detection (–≤—Å—Ç—Ä–æ–µ–Ω–æ –≤ retrieve)] ‚Üí
  [conditional: complexity == simple? yes‚Üígenerate : no‚Üímultihop] ‚Üí
  multihop ‚Üí merge_context ‚Üí generate ‚Üí route
```

---

### 1.7 –§–∞–π–ª—ã –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è (–≠—Ç–∞–ø 1)

```
app/nodes/multihop/
‚îú‚îÄ‚îÄ __init__.py
‚îú‚îÄ‚îÄ complexity_detector.py      # ComplexityDetector –∫–ª–∞—Å—Å
‚îú‚îÄ‚îÄ hop_resolver.py             # HopResolver –∫–ª–∞—Å—Å
‚îú‚îÄ‚îÄ relation_graph.py           # RelationGraphBuilder –∫–ª–∞—Å—Å
‚îú‚îÄ‚îÄ context_merger.py           # ContextMerger –∫–ª–∞—Å—Å
‚îú‚îÄ‚îÄ models.py                   # Pydantic –º–æ–¥–µ–ª–∏ –¥–ª—è –≤—ã–≤–æ–¥–∞
‚îú‚îÄ‚îÄ node.py                     # –û–±—ë—Ä—Ç–∫–∞ LangGraph —É–∑–ª–∞
‚îî‚îÄ‚îÄ prompts.py                  # –®–∞–±–ª–æ–Ω—ã –∑–∞–ø—Ä–æ—Å–æ–≤ (–µ—Å–ª–∏ –Ω—É–∂–Ω—ã)
```

---

## üéØ –≠–¢–ê–ü 2: –ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ —á–∞—Å—Ç–æ –∑–∞–¥–∞–≤–∞–µ–º—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤ ‚Äî 3-4 –¥–Ω—è

### 2.1 –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è

```
–í–æ–ø—Ä–æ—Å ‚Üí –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è ‚Üí –•–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ ‚Üí
  ‚îú‚îÄ –ù–∞–π–¥–µ–Ω –≤ –∫—ç—à–µ ‚Üí –≤–µ—Ä–Ω—É—Ç—å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç
  ‚îî‚îÄ –ù–µ –Ω–∞–π–¥–µ–Ω ‚Üí –ø–æ–ª–Ω—ã–π –ø–∞–π–ø–ª–∞–π–Ω ‚Üí —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ –∫—ç—à
```

**–ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:**
- **Query Normalizer** ‚Äî –Ω–æ—Ä–º–∞–ª–∏–∑–∏—Ä—É–µ—Ç –≤–æ–ø—Ä–æ—Å (—É–¥–∞–ª—è–µ—Ç –ø—É–Ω–∫—Ç—É–∞—Ü–∏—é, –ø—Ä–∏–≤–æ–¥–∏—Ç –≤ –Ω–∏–∂–Ω–∏–π —Å–ª—É—á–∞–π –∏ —Ç.–¥.)
- **Cache Layer** ‚Äî —Ö—Ä–∞–Ω–∏—Ç —á–∞—Å—Ç–æ –∑–∞–¥–∞–≤–∞–µ–º—ã–µ –≤–æ–ø—Ä–æ—Å—ã –∏ –æ—Ç–≤–µ—Ç—ã
- **Cache Manager** ‚Äî —É–ø—Ä–∞–≤–ª—è–µ—Ç LRU –∏–ª–∏ TTL –∫—ç—à–µ–º
- **Analytics** ‚Äî –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç hit rate –∫—ç—à–∞

---

### 2.2 Query Normalizer (`app/cache/query_normalizer.py`)

**–õ–æ–≥–∏–∫–∞ –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏:**

```python
def normalize_query(query: str) -> str:
    """
    –ü—Ä–∏–≤–æ–¥–∏—Ç —Ä–∞–∑–Ω—ã–µ —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∏ –æ–¥–Ω–æ–≥–æ –≤–æ–ø—Ä–æ—Å–∞ –∫ –æ–¥–Ω–æ–π —Ñ–æ—Ä–º–µ.

    –ü—Ä–∏–º–µ—Ä—ã:
    - "How to reset password?" ‚Üí "how reset password"
    - "how reset my password?" ‚Üí "how reset password"
    - "Reset password, please" ‚Üí "reset password"
    """

    steps:
    1. –ü—Ä–∏–≤–æ–¥–∏—Ç—å –≤ –Ω–∏–∂–Ω–∏–π —Å–ª—É—á–∞–π
    2. –£–¥–∞–ª–∏—Ç—å –ø—É–Ω–∫—Ç—É–∞—Ü–∏—é (?, !, .)
    3. –£–¥–∞–ª–∏—Ç—å —Å—Ç–æ–ø-—Å–ª–æ–≤–∞ (how, what, can, do, please)
    4. –£–¥–∞–ª–∏—Ç—å –¥—É–±–ª–∏—Ä—É—é—â–∏–µ—Å—è –ø—Ä–æ–±–µ–ª—ã
    5. –°–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ (–¥–ª—è "reset password" –∏ "password reset" ‚Üí –æ–¥–Ω–æ –∏ —Ç–æ –∂–µ)

    –†–µ–∑—É–ª—å—Ç–∞—Ç: "reset password"
```

---

### 2.3 Cache Layer (`app/cache/cache_layer.py`)

**–¢–µ—Ö–Ω–æ–ª–æ–≥–∏—è:** Redis (–µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–µ–Ω) –∏–ª–∏ –≤ –ø–∞–º—è—Ç–∏ (–¥–ª—è dev)

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞:**

```python
class CacheEntry(BaseModel):
    query_normalized: str
    query_original: str
    answer: str
    doc_ids: List[str]  # –∫–∞–∫–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏—Å—å
    confidence: float
    timestamp: datetime
    hit_count: int = 0  # —Å–∫–æ–ª—å–∫–æ —Ä–∞–∑ –±—ã–ª –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω
    user_rating: Optional[float] = None  # –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ü–µ–Ω–∏–ª –æ—Ç–≤–µ—Ç

class CacheManager:
    # LRU –∫—ç—à –≤ –ø–∞–º—è—Ç–∏
    cache: Dict[str, CacheEntry]
    max_cache_size: int = 1000  # –º–∞–∫—Å–∏–º—É–º –∑–∞–ø–∏—Å–µ–π
    ttl_seconds: int = 3600 * 24  # 24 —á–∞—Å–∞

    def get(query: str) -> Optional[CacheEntry]
    def set(query: str, answer: str, docs: List[str], confidence: float)
    def delete(query: str)
    def clear_expired()
    def get_stats() -> CacheStats
```

---

### 2.4 Cache Statistics (`app/cache/cache_stats.py`)

**–û—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º—ã–µ –º–µ—Ç—Ä–∏–∫–∏:**

```python
class CacheStats(BaseModel):
    total_requests: int
    cache_hits: int
    cache_misses: int
    hit_rate: float  # hits / (hits + misses)
    avg_response_time_cached: float  # –º—Å
    avg_response_time_full: float  # –º—Å
    savings_time: float  # total_time_saved –≤ —Å–µ–∫—É–Ω–¥–∞—Ö
    memory_usage: float  # KB
    most_asked_questions: List[str]  # top 5
```

---

### 2.5 –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ –ø–∞–π–ø–ª–∞–π–Ω

**–†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ –≤ `app/pipeline/state.py`:**

```python
cache_hit: Optional[bool]
cache_key: Optional[str]
```

**–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ graph.py:**

```
START ‚Üí check_cache ‚Üí
  ‚îú‚îÄ cache_hit: true ‚Üí return_cached_answer ‚Üí END
  ‚îî‚îÄ cache_hit: false ‚Üí classify ‚Üí ... ‚Üí generate ‚Üí store_in_cache ‚Üí END
```

**Node-–æ–±—ë—Ä—Ç–∫–∏:**

```python
# app/cache/nodes.py
async def check_cache_node(state: State) -> State
async def store_in_cache_node(state: State) -> State
```

---

### 2.6 –§–∞–π–ª—ã –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è (–≠—Ç–∞–ø 2)

```
app/cache/
‚îú‚îÄ‚îÄ __init__.py
‚îú‚îÄ‚îÄ query_normalizer.py      # QueryNormalizer –∫–ª–∞—Å—Å
‚îú‚îÄ‚îÄ cache_layer.py           # CacheManager –∫–ª–∞—Å—Å
‚îú‚îÄ‚îÄ cache_stats.py           # CacheStats –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
‚îú‚îÄ‚îÄ models.py                # Pydantic –º–æ–¥–µ–ª–∏
‚îî‚îÄ‚îÄ nodes.py                 # LangGraph —É–∑–ª—ã (check_cache, store_cache)
```

---

## üéØ –≠–¢–ê–ü 3: Telegram –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è ‚Äî 4-5 –¥–Ω–µ–π

### 3.1 –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ Telegram –±–æ—Ç–∞

```
Telegram User ‚Üí
  /start ‚Üí initialize session
  /ask "–≤–æ–ø—Ä–æ—Å" ‚Üí process_query (—Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º –¥–∏–∞–ª–æ–≥–∞)
  /clear ‚Üí clear_context
  /history ‚Üí show_conversation
  /rate ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê ‚Üí feedback
  /settings ‚Üí user_settings
```

**–ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:**
- **Session Manager** ‚Äî —É–ø—Ä–∞–≤–ª—è–µ—Ç —Å–µ—Å—Å–∏–µ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º
- **Dialog Manager** ‚Äî —É–ø—Ä–∞–≤–ª—è–µ—Ç –ª–æ–≥–∏–∫–æ–π –¥–∏–∞–ª–æ–≥–∞ –∏ –∏—Å—Ç–æ—Ä–∏–µ–π
- **Telegram Bot Handler** ‚Äî –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–æ–±—â–µ–Ω–∏–π
- **Context Store** ‚Äî —Ö—Ä–∞–Ω–∏—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç —Ä–∞–∑–≥–æ–≤–æ—Ä–∞ (–≤ Redis –∏–ª–∏ PostgreSQL)

---

### 3.2 Session Manager (`app/integrations/telegram/session_manager.py`)

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞:**

```python
class UserSession(BaseModel):
    user_id: int  # Telegram user_id
    username: str
    conversation_history: List[Message]  # –∏—Å—Ç–æ—Ä–∏—è –¥–∏–∞–ª–æ–≥–∞
    context: Dict[str, Any]  # –∫–æ–Ω—Ç–µ–∫—Å—Ç (—Ç–µ–∫—É—â–∏–π –∏–Ω—Ç–µ–Ω—Ç, category –∏ —Ç.–¥.)
    created_at: datetime
    last_updated: datetime
    preferences: UserPreferences  # —è–∑—ã–∫, —Å—Ç–∏–ª—å –æ—Ç–≤–µ—Ç–æ–≤ –∏ —Ç.–¥.

class Message(BaseModel):
    role: Literal["user", "assistant"]
    content: str
    timestamp: datetime
    query_id: Optional[str]  # –¥–ª—è —Å–≤—è–∑–∏ —Å –ø–∞–π–ø–ª–∞–π–Ω–æ–º

class UserPreferences(BaseModel):
    language: str = "ru"
    include_sources: bool = True
    response_format: Literal["short", "detailed"] = "detailed"
```

**–§—É–Ω–∫—Ü–∏–∏:**

```python
class SessionManager:
    def create_session(user_id: int, username: str) -> UserSession
    async def get_session(user_id: int) -> Optional[UserSession]
    async def update_session(user_id: int, **updates)
    async def add_message(user_id: int, role: str, content: str)
    async def clear_history(user_id: int)
    async def get_context(user_id: int) -> Dict
    async def set_context(user_id: int, **context_data)
    async def delete_session(user_id: int)  # –Ω–∞ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
```

---

### 3.3 Dialog Manager (`app/integrations/telegram/dialog_manager.py`)

**–õ–æ–≥–∏–∫–∞ –¥–∏–∞–ª–æ–≥–∞ —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞:**

```python
class DialogManager:
    """
    –£–ø—Ä–∞–≤–ª—è–µ—Ç –ª–æ–≥–∏–∫–æ–π –¥–∏–∞–ª–æ–≥–∞ —Å —É—á—ë—Ç–æ–º –∏—Å—Ç–æ—Ä–∏–∏ –∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞.
    """

    async def process_query(
        user_id: int,
        query: str
    ) -> DialogResponse:
        """
        –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤–æ–ø—Ä–æ—Å–∞ —Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º —Å–µ—Å—Å–∏–∏.
        """

        steps:
        1. –ü–æ–ª—É—á–∏—Ç—å UserSession
        2. –î–æ–±–∞–≤–∏—Ç—å query –≤ conversation_history
        3. –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å, related –ª–∏ query –∫ –ø—Ä–µ–¥—ã–¥—É—â–µ–º—É –∫–æ–Ω—Ç–µ–∫—Å—Ç—É
           - –ï—Å–ª–∏ related: –ø–µ—Ä–µ–¥–∞—Ç—å context –≤ –ø–∞–π–ø–ª–∞–π–Ω
           - –ï—Å–ª–∏ –Ω–æ–≤—ã–π —Ç–æ–ø–∏–∫: reset context
        4. –ó–∞–ø—É—Å—Ç–∏—Ç—å RAG –ø–∞–π–ø–ª–∞–π–Ω (—Å context)
        5. –ü–æ–ª—É—á–∏—Ç—å response –æ—Ç –ø–∞–π–ø–ª–∞–π–Ω–∞
        6. –î–æ–±–∞–≤–∏—Ç—å response –≤ conversation_history
        7. –û–±–Ω–æ–≤–∏—Ç—å context –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ query
        8. –í–µ—Ä–Ω—É—Ç—å DialogResponse (–æ—Ç–≤–µ—Ç + –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ)

        –ü—Ä–∏–º–µ—Ä –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞:
        {
            "current_intent": "reset_password",
            "category": "Account Access",
            "hop_level": 1,  # —Å–ª–æ–∂–Ω–æ—Å—Ç—å –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –≤–æ–ø—Ä–æ—Å–∞
        }

        –ï—Å–ª–∏ –Ω–æ–≤—ã–π –≤–æ–ø—Ä–æ—Å –∫–∞—Å–∞–µ—Ç—Å—è –¥—Ä—É–≥–æ–≥–æ –∏–Ω—Ç–µ–Ω—Ç–∞:
        ‚Üí —Å–±—Ä–æ—Å–∏—Ç—å —Å—Ç–∞—Ä—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç (–∫—Ä–æ–º–µ –∏—Å—Ç–æ—Ä–∏–∏)
```

**–í—ã—Ö–æ–¥:**

```python
class DialogResponse(BaseModel):
    answer: str
    sources: List[{"title": str, "doc_id": str}]
    confidence: float
    followup_questions: Optional[List[str]]  # –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å —É—Ç–æ—á–Ω—è—é—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã
    user_rating_prompt: bool = True  # –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å –æ—Ü–µ–Ω–∏—Ç—å –æ—Ç–≤–µ—Ç
```

---

### 3.4 Telegram Bot Handler (`app/integrations/telegram/bot_handler.py`)

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∫–æ–º–∞–Ω–¥:**

```python
from telegram import Update
from telegram.ext import (
    Application, CommandHandler, MessageHandler,
    ContextTypes, filters
)

class TelegramBotHandler:
    def __init__(self, token: str):
        self.token = token
        self.app = Application.builder().token(token).build()
        self._setup_handlers()

    def _setup_handlers(self):
        """
        –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –∫–æ–º–∞–Ω–¥ –∏ —Å–æ–æ–±—â–µ–Ω–∏–π.
        """

        # –ö–æ–º–∞–Ω–¥—ã
        self.app.add_handler(CommandHandler("start", self.cmd_start))
        self.app.add_handler(CommandHandler("ask", self.cmd_ask))
        self.app.add_handler(CommandHandler("clear", self.cmd_clear))
        self.app.add_handler(CommandHandler("history", self.cmd_history))
        self.app.add_handler(CommandHandler("rate", self.cmd_rate))
        self.app.add_handler(CommandHandler("settings", self.cmd_settings))

        # –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ–±—ã—á–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
        self.app.add_handler(
            MessageHandler(filters.TEXT & ~filters.COMMAND, self.handle_message)
        )

        # –û–±—Ä–∞–±–æ—Ç–∫–∞ callbacks (–∫–Ω–æ–ø–∫–∏)
        self.app.add_handler(CallbackQueryHandler(self.handle_callback))

    async def cmd_start(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """
        /start ‚Äî –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Å–µ—Å—Å–∏—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
        """
        user_id = update.effective_user.id
        username = update.effective_user.username

        session = await session_manager.create_session(user_id, username)

        text = f"""
        üëã –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, {username}!

        –≠—Ç–æ Support RAG –±–æ—Ç. –í–æ—Ç —á—Ç–æ —è –º–æ–≥—É –¥–µ–ª–∞—Ç—å:

        /ask "–≤–æ–ø—Ä–æ—Å" ‚Äî –∑–∞–¥–∞—Ç—å –≤–æ–ø—Ä–æ—Å
        /clear ‚Äî –æ—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é –¥–∏–∞–ª–æ–≥–∞
        /history ‚Äî –ø–æ–∫–∞–∑–∞—Ç—å –∏—Å—Ç–æ—Ä–∏—é
        /rate ‚≠ê ‚Äî –æ—Ü–µ–Ω–∏—Ç—å –æ—Ç–≤–µ—Ç
        /settings ‚Äî –Ω–∞—Å—Ç—Ä–æ–π–∫–∏

        –ò–ª–∏ –ø—Ä–æ—Å—Ç–æ –Ω–∞–ø–∏—à–∏—Ç–µ –≤–æ–ø—Ä–æ—Å —Å–æ–æ–±—â–µ–Ω–∏–µ–º!
        """

        await update.message.reply_text(text)

    async def cmd_ask(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """
        /ask "–≤–æ–ø—Ä–æ—Å" ‚Äî –∑–∞–¥–∞—Ç—å –≤–æ–ø—Ä–æ—Å —Å –∞—Ä–≥—É–º–µ–Ω—Ç–æ–º.
        """
        user_id = update.effective_user.id

        if not context.args:
            await update.message.reply_text(
                "‚ö†Ô∏è –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: /ask \"–≤–∞—à –≤–æ–ø—Ä–æ—Å\""
            )
            return

        query = " ".join(context.args)
        await self._process_and_respond(update, user_id, query)

    async def cmd_clear(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """
        /clear ‚Äî –æ—á–∏—Å—Ç–∏—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–∏–∞–ª–æ–≥–∞ –∏ –∏—Å—Ç–æ—Ä–∏—é.
        """
        user_id = update.effective_user.id

        # –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø–µ—Ä–µ–¥ –æ—á–∏—Å—Ç–∫–æ–π
        keyboard = [
            [
                InlineKeyboardButton("‚úÖ –î–∞, –æ—á–∏—Å—Ç–∏—Ç—å", callback_data="clear_confirm"),
                InlineKeyboardButton("‚ùå –û—Ç–º–µ–Ω–∞", callback_data="clear_cancel")
            ]
        ]

        reply_markup = InlineKeyboardMarkup(keyboard)
        await update.message.reply_text(
            "‚ö†Ô∏è –í—ã —É–≤–µ—Ä–µ–Ω—ã? –≠—Ç–æ —É–¥–∞–ª–∏—Ç –≤—Å—é –∏—Å—Ç–æ—Ä–∏—é.",
            reply_markup=reply_markup
        )

    async def cmd_history(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """
        /history ‚Äî –ø–æ–∫–∞–∑–∞—Ç—å –∏—Å—Ç–æ—Ä–∏—é –ø–æ—Å–ª–µ–¥–Ω–∏—Ö 10 —Å–æ–æ–±—â–µ–Ω–∏–π.
        """
        user_id = update.effective_user.id
        session = await session_manager.get_session(user_id)

        if not session or len(session.conversation_history) == 0:
            await update.message.reply_text("üìù –ò—Å—Ç–æ—Ä–∏—è –ø—É—Å—Ç–∞.")
            return

        # –ü–æ—Å–ª–µ–¥–Ω–∏–µ 10 —Å–æ–æ–±—â–µ–Ω–∏–π
        messages = session.conversation_history[-10:]
        text = "üìù –ò—Å—Ç–æ—Ä–∏—è –¥–∏–∞–ª–æ–≥–∞ (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 10):\n\n"

        for msg in messages:
            role_emoji = "üë§" if msg.role == "user" else "ü§ñ"
            text += f"{role_emoji} {msg.content[:100]}...\n"

        await update.message.reply_text(text)

    async def cmd_rate(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """
        /rate ‚≠ê‚≠ê‚≠ê‚≠ê ‚Äî –æ—Ü–µ–Ω–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–π –æ—Ç–≤–µ—Ç.
        """
        user_id = update.effective_user.id

        if not context.args:
            await update.message.reply_text(
                "‚ö†Ô∏è –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: /rate ‚≠ê‚≠ê‚≠ê‚≠ê"
            )
            return

        rating_str = context.args[0]
        rating = rating_str.count('‚≠ê')  # –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–≤—ë–∑–¥

        if rating < 1 or rating > 5:
            await update.message.reply_text(
                "‚ö†Ô∏è –û—Ü–µ–Ω–∫–∞ –æ—Ç 1‚≠ê –¥–æ 5‚≠ê"
            )
            return

        # –ù–∞–π—Ç–∏ –ø–æ—Å–ª–µ–¥–Ω–∏–π –æ—Ç–≤–µ—Ç –±–æ—Ç–∞
        session = await session_manager.get_session(user_id)
        if not session.conversation_history:
            await update.message.reply_text("üìù –ù–µ—á–µ–≥–æ –æ—Ü–µ–Ω–∏–≤–∞—Ç—å.")
            return

        # –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ä–µ–π—Ç–∏–Ω–≥
        await feedback_store.save_rating(
            user_id=user_id,
            query=session.conversation_history[-2].content,  # –ø—Ä–µ–¥–ø–æ—Å–ª–µ–¥–Ω–µ–µ (–≤–æ–ø—Ä–æ—Å)
            answer=session.conversation_history[-1].content,  # –ø–æ—Å–ª–µ–¥–Ω–µ–µ (–æ—Ç–≤–µ—Ç)
            rating=rating
        )

        await update.message.reply_text(f"‚úÖ –°–ø–∞—Å–∏–±–æ! –í—ã –æ—Ü–µ–Ω–∏–ª–∏ –Ω–∞ {rating_str}")

    async def cmd_settings(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """
        /settings ‚Äî —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏.
        """
        user_id = update.effective_user.id
        session = await session_manager.get_session(user_id)

        keyboard = [
            [InlineKeyboardButton("üåç –Ø–∑—ã–∫", callback_data="settings_language")],
            [InlineKeyboardButton("üìã –î–ª–∏–Ω–∞ –æ—Ç–≤–µ—Ç–∞", callback_data="settings_response_format")],
            [InlineKeyboardButton("üîó –ò—Å—Ç–æ—á–Ω–∏–∫–∏", callback_data="settings_sources")],
            [InlineKeyboardButton("‚ùå –ó–∞–∫—Ä—ã—Ç—å", callback_data="settings_close")]
        ]

        reply_markup = InlineKeyboardMarkup(keyboard)
        await update.message.reply_text(
            "‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏:",
            reply_markup=reply_markup
        )

    async def handle_message(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """
        –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ–±—ã—á–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è.
        –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–æ—Å—Ç–æ –ø–∏—à–µ—Ç –≤–æ–ø—Ä–æ—Å.
        """
        user_id = update.effective_user.id
        query = update.message.text

        await self._process_and_respond(update, user_id, query)

    async def _process_and_respond(
        self,
        update: Update,
        user_id: int,
        query: str
    ):
        """
        –û—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤–æ–ø—Ä–æ—Å–∞.
        """
        # –ü–æ–∫–∞–∑–∞—Ç—å –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø–µ—á–∞—Ç–∏
        async with update.message.chat.action(ChatAction.TYPING):
            try:
                # –û–±—Ä–∞–±–æ—Ç–∞—Ç—å —á–µ—Ä–µ–∑ dialog_manager
                dialog_response = await dialog_manager.process_query(user_id, query)

                # –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞—Ç—å –æ—Ç–≤–µ—Ç
                response_text = f"""
ü§ñ {dialog_response.answer}

**–ò—Å—Ç–æ—á–Ω–∏–∫–∏:**
"""
                for src in dialog_response.sources:
                    response_text += f"- [{src['title']}]"

                response_text += f"\n\n–î–æ–≤–µ—Ä–∏–µ: {dialog_response.confidence:.0%}"

                # –û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç–≤–µ—Ç
                await update.message.reply_text(response_text, parse_mode="Markdown")

                # –ü—Ä–µ–¥–ª–æ–∂–∏—Ç—å –æ—Ü–µ–Ω–∏—Ç—å (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
                if dialog_response.user_rating_prompt:
                    keyboard = [
                        [
                            InlineKeyboardButton("‚≠ê", callback_data="rate_1"),
                            InlineKeyboardButton("‚≠ê‚≠ê", callback_data="rate_2"),
                            InlineKeyboardButton("‚≠ê‚≠ê‚≠ê", callback_data="rate_3"),
                            InlineKeyboardButton("‚≠ê‚≠ê‚≠ê‚≠ê", callback_data="rate_4"),
                            InlineKeyboardButton("‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê", callback_data="rate_5"),
                        ]
                    ]

                    reply_markup = InlineKeyboardMarkup(keyboard)
                    await update.message.reply_text(
                        "–û—Ü–µ–Ω–∏—Ç–µ –æ—Ç–≤–µ—Ç:",
                        reply_markup=reply_markup
                    )

                # –ü—Ä–µ–¥–ª–æ–∂–∏—Ç—å —É—Ç–æ—á–Ω—è—é—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã
                if dialog_response.followup_questions:
                    text = "–ú–æ–∂–µ—Ç –±—ã—Ç—å, –≤–∞—Å –∏–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç:\n"
                    for i, q in enumerate(dialog_response.followup_questions[:3]):
                        text += f"{i+1}. {q}\n"
                    await update.message.reply_text(text)

            except Exception as e:
                logger.error(f"Error processing query: {e}")
                await update.message.reply_text(
                    "‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ."
                )

    async def handle_callback(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """
        –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞–∂–∞—Ç–∏–π –Ω–∞ –∫–Ω–æ–ø–∫–∏ (inline keyboard).
        """
        query = update.callback_query
        await query.answer()

        user_id = update.effective_user.id

        if query.data == "clear_confirm":
            await session_manager.clear_history(user_id)
            await query.edit_message_text("‚úÖ –ò—Å—Ç–æ—Ä–∏—è –æ—á–∏—â–µ–Ω–∞.")

        elif query.data == "clear_cancel":
            await query.edit_message_text("‚ùå –û—Ç–º–µ–Ω–µ–Ω–æ.")

        elif query.data.startswith("rate_"):
            rating = int(query.data.split("_")[1])
            await feedback_store.save_rating(user_id, rating)
            await query.edit_message_text(f"‚úÖ –°–ø–∞—Å–∏–±–æ! –í—ã –æ—Ü–µ–Ω–∏–ª–∏ –Ω–∞ {'‚≠ê' * rating}")

        elif query.data.startswith("settings_"):
            # –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫
            await self._handle_settings_callback(query, user_id, query.data)

    def start(self):
        """–ó–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞."""
        self.app.run_polling()
```

---

### 3.5 Context Store (`app/integrations/telegram/context_store.py`)

**–¢–µ—Ö–Ω–æ–ª–æ–≥–∏—è:** Redis (production) –∏–ª–∏ PostgreSQL (fallback)

```python
class ContextStore:
    """
    –ü–æ—Å—Ç–æ—è–Ω–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ —Å–µ—Å—Å–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.
    """

    async def save_session(user_id: int, session: UserSession)
    async def load_session(user_id: int) -> Optional[UserSession]
    async def delete_session(user_id: int)
    async def update_message_history(user_id: int, message: Message)
    async def get_recent_messages(user_id: int, limit: int = 10) -> List[Message]
    async def prune_old_sessions(days: int = 30)  # —É–¥–∞–ª–∏—Ç—å —Å—Ç–∞—Ä—ã–µ —Å–µ—Å—Å–∏–∏
```

---

### 3.6 –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ –ø–∞–π–ø–ª–∞–π–Ω

**–í—ã–∑–æ–≤ –ø–∞–π–ø–ª–∞–π–Ω–∞ –∏–∑ Telegram:**

```python
async def process_query(user_id: int, query: str) -> DialogResponse:
    """
    –ó–∞–ø—É—Å–∫ RAG –ø–∞–π–ø–ª–∞–π–Ω–∞ —Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º —Å–µ—Å—Å–∏–∏.
    """

    session = await session_manager.get_session(user_id)

    # –ü–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å input –¥–ª—è –ø–∞–π–ø–ª–∞–π–Ω–∞
    input_state = {
        "question": query,
        "user_id": user_id,
        "conversation_context": session.context,  # –ø–µ—Ä–µ–¥–∞—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç
    }

    # –ó–∞–ø—É—Å—Ç–∏—Ç—å –ø–∞–π–ø–ª–∞–π–Ω
    result = await rag_graph.ainvoke(input_state)

    # –ò–∑–≤–ª–µ—á—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç
    answer = result.get("answer", "")
    confidence = result.get("confidence", 0)
    sources = result.get("best_doc_metadata", {})

    return DialogResponse(
        answer=answer,
        sources=[sources] if sources else [],
        confidence=confidence,
        followup_questions=await generate_followup_questions(query, answer),
    )
```

---

### 3.7 –§–∞–π–ª—ã –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è (–≠—Ç–∞–ø 3)

```
app/integrations/telegram/
‚îú‚îÄ‚îÄ __init__.py
‚îú‚îÄ‚îÄ bot_handler.py           # TelegramBotHandler –∫–ª–∞—Å—Å
‚îú‚îÄ‚îÄ session_manager.py       # SessionManager –∫–ª–∞—Å—Å
‚îú‚îÄ‚îÄ dialog_manager.py        # DialogManager –∫–ª–∞—Å—Å
‚îú‚îÄ‚îÄ context_store.py         # ContextStore –∫–ª–∞—Å—Å
‚îú‚îÄ‚îÄ models.py                # Pydantic –º–æ–¥–µ–ª–∏ (UserSession –∏ —Ç.–¥.)
‚îú‚îÄ‚îÄ commands/
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îú‚îÄ‚îÄ start.py
‚îÇ   ‚îú‚îÄ‚îÄ ask.py
‚îÇ   ‚îú‚îÄ‚îÄ clear.py
‚îÇ   ‚îú‚îÄ‚îÄ history.py
‚îÇ   ‚îú‚îÄ‚îÄ rate.py
‚îÇ   ‚îî‚îÄ‚îÄ settings.py
‚îî‚îÄ‚îÄ main.py                  # –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞ –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –±–æ—Ç–∞

scripts/
‚îî‚îÄ‚îÄ run_telegram_bot.py      # –°–∫—Ä–∏–ø—Ç –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –±–æ—Ç–∞
```

---

### 3.8 –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Telegram –±–æ—Ç–∞

**`app/config/telegram_config.py`:**

```python
from pydantic import BaseModel

class TelegramConfig(BaseModel):
    token: str  # –∏–∑ .env: TELEGRAM_BOT_TOKEN
    webhook_url: Optional[str] = None  # –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞
    max_conversation_length: int = 50  # –º–∞–∫—Å–∏–º—É–º —Å–æ–æ–±—â–µ–Ω–∏–π –≤ –∏—Å—Ç–æ—Ä–∏–∏
    session_ttl_hours: int = 24  # –≤—Ä–µ–º—è –∂–∏–∑–Ω–∏ —Å–µ—Å—Å–∏–∏
    enable_analytics: bool = True
    allowed_user_ids: Optional[List[int]] = None  # –µ—Å–ª–∏ –Ω—É–∂–Ω–æ –æ–≥—Ä–∞–Ω–∏—á–∏—Ç—å –¥–æ—Å—Ç—É–ø

class TelegramIntegrationSettings(BaseModel):
    enabled: bool = True
    config: TelegramConfig
```

**`.env` –ø—Ä–∏–º–µ—Ä:**

```env
TELEGRAM_BOT_TOKEN=your_bot_token_here
TELEGRAM_WEBHOOK_URL=https://your-domain.com/telegram/webhook
```

---

## üéØ –≠–¢–ê–ü 4: –î–∏–∞–ª–æ–≥–æ–≤–∞—è –ª–æ–≥–∏–∫–∞ –∏ —É–ª—É—á—à–µ–Ω–∏—è ‚Äî 2-3 –¥–Ω—è

### 4.1 Follow-up –≤–æ–ø—Ä–æ—Å—ã

**–õ–æ–≥–∏–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —É—Ç–æ—á–Ω—è—é—â–∏—Ö –≤–æ–ø—Ä–æ—Å–æ–≤:**

```python
async def generate_followup_questions(
    original_query: str,
    answer: str,
    context_docs: List[str]
) -> List[str]:
    """
    –ù–∞ –æ—Å–Ω–æ–≤–µ –æ—Ç–≤–µ—Ç–∞ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç 3 —É—Ç–æ—á–Ω—è—é—â–∏—Ö –≤–æ–ø—Ä–æ—Å–∞.
    """

    # –ü—Ä–∞–≤–∏–ª–∞ (–±–µ–∑ LLM):
    1. –ï—Å–ª–∏ –æ—Ç–≤–µ—Ç —É–ø–æ–º—è–Ω—É–ª related_topics –≤ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö
       ‚Üí –¥–æ–±–∞–≤–∏—Ç—å –≤–æ–ø—Ä–æ—Å –ø—Ä–æ related_topic

    2. –ï—Å–ª–∏ –æ—Ç–≤–µ—Ç –Ω–µ–ø–æ–ª–Ω—ã–π (has_complete_answer = false)
       ‚Üí –¥–æ–±–∞–≤–∏—Ç—å –≤–æ–ø—Ä–æ—Å "–•–æ—Ç–∏—Ç–µ —É–∑–Ω–∞—Ç—å –±–æ–ª–µ–µ –ø–æ–¥—Ä–æ–±–Ω–æ?"

    3. –ï—Å–ª–∏ –≤–æ–ø—Ä–æ—Å –±—ã–ª –ø—Ä–æ –∏—Å–∫–ª—é—á–µ–Ω–∏–µ
       ‚Üí –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å –ø—Ä–æ—Ç–∏–≤–æ–ø–æ–ª–æ–∂–Ω—ã–π –≤–æ–ø—Ä–æ—Å
       –ü—Ä–∏–º–µ—Ä: "–ö–∞–∫ –ù–ï –¥–µ–ª–∞—Ç—å" ‚Üí "–ö–∞–∫ –¥–µ–ª–∞—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω–æ?"

    –†–µ–∑—É–ª—å—Ç–∞—Ç: List[str] —Å 3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è–º–∏
```

---

### 4.2 Feedback —Å–∏—Å—Ç–µ–º–∞

**–õ–æ–≥–∏–∫–∞ —Å–±–æ—Ä–∞ –æ–±—Ä–∞—Ç–Ω–æ–π —Å–≤—è–∑–∏:**

```python
class FeedbackStore:
    """
    –°–±–æ—Ä —Ä–µ–π—Ç–∏–Ω–≥–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏ –æ—Ç–∑—ã–≤–æ–≤.
    """

    async def save_rating(
        user_id: int,
        query: str,
        answer: str,
        rating: int,  # 1-5
        comment: Optional[str] = None
    ):
        """
        –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ä–µ–π—Ç–∏–Ω–≥ –æ—Ç–≤–µ—Ç–∞.
        –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è:
        - –£–ª—É—á—à–µ–Ω–∏—è –ø–∞–π–ø–ª–∞–π–Ω–∞
        - –ü–µ—Ä–µ–æ–±—É—á–µ–Ω–∏—è –º–æ–¥–µ–ª–∏ —Ä–∞–Ω–∂–∏—Ä–æ–≤–∞–Ω–∏—è
        - –ê–Ω–∞–ª–∏–∑–∞ –ø—Ä–æ–±–ª–µ–º–Ω—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤
        """
        pass

    async def get_feedback_analytics() -> FeedbackStats:
        """
        –ü–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ —Ä–µ–π—Ç–∏–Ω–≥–∞–º.
        """
        pass
```

---

### 4.3 –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Langfuse

**–û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –º–µ—Ç—Ä–∏–∫ –≤ Telegram –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ:**

```python
@observe()  # Langfuse —Ç—Ä–µ–π—Å–∏–Ω–≥
async def process_query(user_id: int, query: str) -> DialogResponse:
    """
    –í—Å–µ –≤—ã–∑–æ–≤—ã –ø–∞–π–ø–ª–∞–π–Ω–∞ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è –≤ Langfuse —Å:
    - user_id (–¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –ø–æ–≤–µ–¥–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è)
    - session_id (–¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –¥–∏–∞–ª–æ–≥–æ–≤)
    - complexity_level (–¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ —Ç–∏–ø–æ–≤ –≤–æ–ø—Ä–æ—Å–æ–≤)
    - cache_hit (–±—ã–ª –ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω –∫—ç—à)
    - multihop_used (–±—ã–ª–∞ –ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∞ multi-hop –ª–æ–≥–∏–∫–∞)
    - response_time
    - user_rating (–µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ü–µ–Ω–∏–ª)
    """
```

---

## üìä –ü–æ–ª–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –ø–æ—Å–ª–µ –≤—Å–µ—Ö —ç—Ç–∞–ø–æ–≤

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                         Telegram User                       ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                               ‚îÇ
‚îÇ  /ask "–≤–æ–ø—Ä–æ—Å"  ‚Üí  SessionManager ‚Üí DialogManager           ‚îÇ
‚îÇ                                          ‚Üì                   ‚îÇ
‚îÇ                     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
‚îÇ                     ‚îÇ      RAG Pipeline (Enhanced)        ‚îÇ  ‚îÇ
‚îÇ                     ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§  ‚îÇ
‚îÇ                     ‚îÇ 1. Check Cache                      ‚îÇ  ‚îÇ
‚îÇ                     ‚îÇ    ‚îú‚îÄ if hit ‚Üí return cached        ‚îÇ  ‚îÇ
‚îÇ                     ‚îÇ    ‚îî‚îÄ if miss ‚Üí continue            ‚îÇ  ‚îÇ
‚îÇ                     ‚îÇ                                      ‚îÇ  ‚îÇ
‚îÇ                     ‚îÇ 2. Classify (intent, category)      ‚îÇ  ‚îÇ
‚îÇ                     ‚îÇ 3. Metadata Filter                  ‚îÇ  ‚îÇ
‚îÇ                     ‚îÇ 4. Retrieve (top-k docs)            ‚îÇ  ‚îÇ
‚îÇ                     ‚îÇ 5. Complexity Detection             ‚îÇ  ‚îÇ
‚îÇ                     ‚îÇ 6. Multi-Hop Resolver (if complex)  ‚îÇ  ‚îÇ
‚îÇ                     ‚îÇ    ‚îú‚îÄ Hop 0: primary doc            ‚îÇ  ‚îÇ
‚îÇ                     ‚îÇ    ‚îú‚îÄ Hop 1+: related docs          ‚îÇ  ‚îÇ
‚îÇ                     ‚îÇ    ‚îî‚îÄ Merge context                 ‚îÇ  ‚îÇ
‚îÇ                     ‚îÇ 7. Generate Answer                  ‚îÇ  ‚îÇ
‚îÇ                     ‚îÇ 8. Route (auto_reply/handoff)       ‚îÇ  ‚îÇ
‚îÇ                     ‚îÇ 9. Store in Cache                   ‚îÇ  ‚îÇ
‚îÇ                     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
‚îÇ                                    ‚Üì                         ‚îÇ
‚îÇ                     DialogResponse + metadata               ‚îÇ
‚îÇ                                    ‚Üì                         ‚îÇ
‚îÇ              Format answer + show sources + rate            ‚îÇ
‚îÇ                                                               ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

Storage Layer:
‚îú‚îÄ PostgreSQL (docs, embeddings, cache)
‚îú‚îÄ Redis (session cache, query cache)
‚îú‚îÄ Langfuse (monitoring, evaluation)
‚îî‚îÄ Telegram API (message delivery)
```

---

## ‚è±Ô∏è –¢–∞–π–º–ª–∞–π–Ω —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

```
–≠–¢–ê–ü 1: Multi-Hop —Ä–∞—Å—Å—É–∂–¥–µ–Ω–∏—è ‚Äî 5-6 –¥–Ω–µ–π
‚îú‚îÄ 1.1 Complexity Detector ‚Äî 1 –¥–µ–Ω—å
‚îú‚îÄ 1.2 Hop Resolver ‚Äî 1.5 –¥–Ω–µ–π
‚îú‚îÄ 1.3 Relation Graph ‚Äî 0.5 –¥–Ω–µ–π
‚îú‚îÄ 1.4 Context Merger ‚Äî 0.5 –¥–Ω–µ–π
‚îú‚îÄ 1.5 –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è + —Ç–µ—Å—Ç—ã ‚Äî 1.5 –¥–Ω–µ–π

–≠–¢–ê–ü 2: –ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ ‚Äî 3-4 –¥–Ω—è
‚îú‚îÄ 2.1 Query Normalizer ‚Äî 0.5 –¥–Ω–µ–π
‚îú‚îÄ 2.2 Cache Layer ‚Äî 1 –¥–µ–Ω—å
‚îú‚îÄ 2.3 Statistics + Monitoring ‚Äî 0.5 –¥–Ω–µ–π
‚îú‚îÄ 2.4 –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è + —Ç–µ—Å—Ç—ã ‚Äî 1.5 –¥–Ω–µ–π

–≠–¢–ê–ü 3: Telegram –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è ‚Äî 4-5 –¥–Ω–µ–π
‚îú‚îÄ 3.1 Session Manager ‚Äî 1 –¥–µ–Ω—å
‚îú‚îÄ 3.2 Dialog Manager ‚Äî 1 –¥–µ–Ω—å
‚îú‚îÄ 3.3 Bot Handler + Commands ‚Äî 1.5 –¥–Ω–µ–π
‚îú‚îÄ 3.4 Context Store ‚Äî 0.5 –¥–Ω–µ–π
‚îú‚îÄ 3.5 –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è + —Ç–µ—Å—Ç—ã ‚Äî 1 –¥–µ–Ω—å

–≠–¢–ê–ü 4: –î–∏–∞–ª–æ–≥–æ–≤–∞—è –ª–æ–≥–∏–∫–∞ ‚Äî 2-3 –¥–Ω—è
‚îú‚îÄ 4.1 Follow-up questions ‚Äî 0.5 –¥–Ω–µ–π
‚îú‚îÄ 4.2 Feedback —Å–∏—Å—Ç–µ–º–∞ ‚Äî 1 –¥–µ–Ω—å
‚îú‚îÄ 4.3 Langfuse –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è ‚Äî 0.5 –¥–Ω–µ–π
‚îú‚îÄ 4.4 E2E —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ ‚Äî 1 –¥–µ–Ω—å

‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
–ò–¢–û–ì–û: 14-18 –¥–Ω–µ–π (–∏–ª–∏ 10-14 –¥–Ω–µ–π –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞)
```

---

## üîÑ –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π –ø–æ—Ä—è–¥–æ–∫ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏

### –í–∞—Ä–∏–∞–Ω—Ç A: –ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ (–±–µ–∑–æ–ø–∞—Å–Ω–µ–µ)
1. –ó–∞–≤–µ—Ä—à–∏—Ç—å –≠—Ç–∞–ø 1 (Multi-Hop) ‚Üí –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å
2. –ó–∞–≤–µ—Ä—à–∏—Ç—å –≠—Ç–∞–ø 2 (Cache) ‚Üí –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å
3. –ó–∞–≤–µ—Ä—à–∏—Ç—å –≠—Ç–∞–ø 3 (Telegram) ‚Üí –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å
4. –ó–∞–≤–µ—Ä—à–∏—Ç—å –≠—Ç–∞–ø 4 (Dialog logic) ‚Üí –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–æ:** –ö–∞–∂–¥—ã–π —ç—Ç–∞–ø —Ç–µ—Å—Ç–∏—Ä—É–µ—Ç—Å—è –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ

---

### –í–∞—Ä–∏–∞–Ω—Ç B: –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ (–±—ã—Å—Ç—Ä–µ–µ, —Ç—Ä–µ–±—É–µ—Ç –∫–æ–æ—Ä–¥–∏–Ω–∞—Ü–∏–∏)
- **Team 1:** –†–∞–∑—Ä–∞–±–æ—Ç–∞—Ç—å –≠—Ç–∞–ø 1 (Multi-Hop)
- **Team 2:** –†–∞–∑—Ä–∞–±–æ—Ç–∞—Ç—å –≠—Ç–∞–ø 2 (Cache) –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ
- **Team 3:** –ù–∞—á–∞—Ç—å –≠—Ç–∞–ø 3 (Telegram) –∫–∞–∫ —Ç–æ–ª—å–∫–æ State –æ–±–Ω–æ–≤–ª—ë–Ω
- **Integ lead:** –ö–æ–æ—Ä–¥–∏–Ω–∏—Ä–æ–≤–∞—Ç—å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–æ:** –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –∑–∞ 10-14 –¥–Ω–µ–π

---

## üìö –°—Ç–∞–Ω–¥–∞—Ä—Ç—ã —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∫–∞–∂–¥–æ–≥–æ —É–∑–ª–∞/–∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞:

```
component/
‚îú‚îÄ‚îÄ __init__.py              # export –ø—É–±–ª–∏—á–Ω—ã–µ –∫–ª–∞—Å—Å—ã
‚îú‚îÄ‚îÄ models.py                # Pydantic –º–æ–¥–µ–ª–∏ (Input/Output)
‚îú‚îÄ‚îÄ service.py               # –æ—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞
‚îú‚îÄ‚îÄ node.py                  # LangGraph —É–∑–µ–ª (–µ—Å–ª–∏ –Ω—É–∂–µ–Ω)
‚îú‚îÄ‚îÄ tests/
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îú‚îÄ‚îÄ test_unit.py        # unit —Ç–µ—Å—Ç—ã
‚îÇ   ‚îî‚îÄ‚îÄ test_integration.py # –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã
‚îî‚îÄ‚îÄ README.md                # –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞
```

### –ü—Ä–∞–≤–∏–ª–∞ –∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è:
- ‚úÖ Type hints –≤–µ–∑–¥–µ
- ‚úÖ Docstrings (Google style)
- ‚úÖ Error handling —Å custom –∏—Å–∫–ª—é—á–µ–Ω–∏—è–º–∏
- ‚úÖ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ –≤—Å–µ—Ö –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö —Ç–æ—á–∫–∞—Ö
- ‚úÖ Unit–æ—Å—Ç—ã –¥–ª—è core –ª–æ–≥–∏–∫–∏ (>80% coverage)
- ‚úÖ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã –¥–ª—è —É–∑–ª–æ–≤

### –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:

```bash
# Unit —Ç–µ—Å—Ç—ã
pytest app/nodes/multihop/tests/test_unit.py -v

# –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã
pytest app/nodes/multihop/tests/test_integration.py -v

# E2E —Ç–µ—Å—Ç—ã (–≤—Å–µ–π —Å–∏—Å—Ç–µ–º—ã —Å Telegram)
pytest tests/e2e/test_telegram_flow.py -v

# –ü–æ–∫—Ä—ã—Ç–∏–µ
pytest --cov=app --cov-report=html
```

---

## ‚úÖ –ú–µ—Ç—Ä–∏–∫–∏ —É—Å–ø–µ—Ö–∞

### –£—Å–ø–µ—Ö –≠—Ç–∞–ø–∞ 1 (Multi-Hop):
- ‚úÖ –î–µ—Ç–µ–∫—Ç–æ—Ä —Å–ª–æ–∂–Ω–æ—Å—Ç–∏: >85% accuracy –Ω–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏
- ‚úÖ Multi-hop —É–ª—É—á—à–∞–µ—Ç recall –Ω–∞ 20-30%
- ‚úÖ –í—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–ª–æ–∂–Ω—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤ <3 —Å–µ–∫
- ‚úÖ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ –ø–∞–π–ø–ª–∞–π–Ω –±–µ–∑ —Ä–µ–≥—Ä–µ—Å—Å–∏–∏

### –£—Å–ø–µ—Ö –≠—Ç–∞–ø–∞ 2 (Cache):
- ‚úÖ Hit rate >40% –Ω–∞ production –¥–∞–Ω–Ω—ã—Ö
- ‚úÖ –£—Å–∫–æ—Ä–µ–Ω–∏–µ –Ω–∞ 80-90% –¥–ª—è –∫—ç—à–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤
- ‚úÖ –°–±–µ—Ä–µ–∂–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ >100 —á–∞—Å–æ–≤ –≤ –º–µ—Å—è—Ü
- ‚úÖ –¢–æ—á–Ω–æ—Å—Ç—å –æ—Ç–≤–µ—Ç–æ–≤ –æ—Å—Ç–∞—ë—Ç—Å—è –Ω–µ–∏–∑–º–µ–Ω–Ω–æ–π

### –£—Å–ø–µ—Ö –≠—Ç–∞–ø–∞ 3 (Telegram):
- ‚úÖ –ë–æ—Ç –ø–æ–¥–Ω–∏–º–∞–µ—Ç—Å—è –±–µ–∑ –æ—à–∏–±–æ–∫
- ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ 100 –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Å–µ—Å—Å–∏–π
- ‚úÖ /clear —Ä–∞–±–æ—Ç–∞–µ—Ç, –æ—á–∏—â–∞—è –≤—Å—é –∏—Å—Ç–æ—Ä–∏—é
- ‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–µ—Å—Å–∏–∏ 24+ —á–∞—Å–∞

### –£—Å–ø–µ—Ö –≠—Ç–∞–ø–∞ 4 (Dialog Logic):
- ‚úÖ Follow-up questions —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã –≤ 90% —Å–ª—É—á–∞–µ–≤
- ‚úÖ Feedback —Å–æ–±–∏—Ä–∞–µ—Ç—Å—è –∏ –ª–æ–≥–∏—Ä—É–µ—Ç—Å—è
- ‚úÖ E2E —Ç–µ—Å—Ç: –≤–æ–ø—Ä–æ—Å ‚Üí –æ—Ç–≤–µ—Ç ‚Üí –æ—Ü–µ–Ω–∫–∞ ‚Üí –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

---

## üöÄ –†–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏–µ

### Dev:
```bash
# –ó–∞–ø—É—Å–∫ –ø–∞–π–ø–ª–∞–π–Ω–∞
uvicorn app.main:app --reload

# –ó–∞–ø—É—Å–∫ Telegram –±–æ—Ç–∞
python scripts/run_telegram_bot.py
```

### Production:
```bash
# Docker compose –¥–ª—è –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤
docker-compose -f docker-compose.yml up -d

# Redis –¥–ª—è –∫—ç—à–∞
docker run -d -p 6379:6379 redis:latest

# PostgreSQL + pgvector
docker run -d \
  -e POSTGRES_PASSWORD=password \
  -p 5432:5432 \
  pgvector/pgvector:latest
```

---

## üìù –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ (requirements.txt –¥–æ–±–∞–≤–∏—Ç—å)

```
# Multi-Hop
spacy>=3.5.0  # –¥–ª—è NER –∏ —Ç–æ–∫–µ–Ω–∏–∑–∞—Ü–∏–∏
networkx>=3.0  # –¥–ª—è –≥—Ä–∞—Ñ–æ–≤ —Å–≤—è–∑–µ–π

# Cache
redis>=5.0.0  # –¥–ª—è –∫—ç—à–∞

# Telegram
python-telegram-bot>=20.0  # –¥–ª—è Telegram –±–æ—Ç–∞
aiogram>=3.0.0  # –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞ (–±–æ–ª–µ–µ async-friendly)

# Feedback
sqlalchemy>=2.0  # –¥–ª—è ORM (–µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º PostgreSQL –Ω–∞–ø—Ä—è–º—É—é)

# –û–±—â–µ–µ
pydantic>=2.0
langchain>=0.1.0
langgraph>=0.1.0
langfuse>=2.0.0
```

---

## üéØ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. ‚úÖ **–£—Ç–≤–µ—Ä–¥–∏—Ç—å —ç—Ç–æ—Ç roadmap** —Å –∫–æ–º–∞–Ω–¥–æ–π
2. üìù **–°–æ–∑–¥–∞—Ç—å issue/tasks** –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —ç—Ç–∞–ø–∞
3. üåø **–°–æ–∑–¥–∞—Ç—å feature branch:** `claude/multi-hop-telegram`
4. üöÄ **–ù–∞—á–∞—Ç—å —Ä–∞–∑—Ä–∞–±–æ—Ç–∫—É** —Å –≠—Ç–∞–ø–∞ 1 (Multi-Hop)
5. üìä **–û—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å** —á–µ—Ä–µ–∑ pull requests

---

**Happy coding! üéâ**
